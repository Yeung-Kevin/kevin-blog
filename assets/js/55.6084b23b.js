(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{409:function(t,o,e){"use strict";e.r(o);var i=e(25),r=Object(i.a)({},(function(){var t=this,o=t.$createElement,e=t._self._c||o;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("div",[e("span",[e("div",[e("div",[e("div",[e("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[e("span",{staticStyle:{"font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px",color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5"}},[t._v("JWT 的介绍")])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt",color:"rgb(227, 0, 0)"}},[t._v("注意: JWT 不局限于在 Django 下使用，也可以在 Flask 等其他框架 或 其他语言下使用")])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("1.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("JWT 的简介")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("ul",[e("li",[e("div",[e("span",{staticStyle:{"font-size":"12pt"}},[t._v("jwt（JSON Web Tokens），是一种开发的行业标准 RFC 7519 ，用于安全的表示双方之间的声明")])])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[e("span",{staticStyle:{"font-size":"12pt"}},[t._v("目前，jwt广泛应用在系统的用户认证方面，特别是现在前后端分离项目")])])])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("2.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("JWT 认证流程")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[e("img",{attrs:{"data-filename":"Image.png",src:"/kevin-blog/Django/JWT - JSON Web Tokens_files/Image.png",type:"image/png"}})])])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("div",[t._v("在项目开发中，一般会按照上图所示的过程进行认证，即：用户登录成功之后，服务端给用户浏览器返回一个token，以后用户浏览器要携带token再去向服务端发送请求，服务端校验token的合法性，合法则给用户看数据，否则，返回一些错误信息")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("3.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt"}},[e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("传统 token方式 和 JWT 在认证方面有什么差异？")])])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("ul",[e("li",[e("div",[t._v("传统token方式")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("用户登录成功后，服务端生成一个随机 token 给用户，并且在服务端"),e("span",{staticStyle:{color:"rgb(250, 122, 0)"}},[t._v("（")]),e("span",{staticStyle:{color:"rgb(250, 122, 0)"}},[t._v("数据库或缓存")]),e("span",{staticStyle:{color:"rgb(250, 122, 0)"}},[t._v("）中保存一份token")]),t._v("，以后用户再来访问时需携带 token，服务端接收到 token 之后，去 数据库 或 缓存 中进行校验 token 的是否超时、是否合法")])])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("jwt方式")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("用户登录成功后，服务端通过 jwt 生成一个随机 token 给用户（"),e("span",{staticStyle:{color:"rgb(250, 122, 0)"}},[t._v("服务端无需保留token")]),t._v("），以后用户再来访问时需携带 token，服务端接收到 token 之后，通过 jwt 对 token 进行校验是否超时、是否合法")])])])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[e("span",{staticStyle:{"font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px",color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5"}},[t._v("JWT 的原理")])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("1.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("用户提交用户名和密码给客户端进行验证，如果登陆成功，使用 JWT 创建一个 token，并且返回给用户")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("ul",[e("li",[e("div",[t._v("jwt 生成的 token 是由三段字符串组成的，并且用 “.” 连接起来")])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{staticStyle:{color:"rgb(227, 0, 0)"}},[t._v("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9")]),t._v("."),e("font",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ")]),t._v("."),e("font",{staticStyle:{color:"rgb(26, 173, 224)"}},[t._v("SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c")])],1)]),e("div",[e("br")]),e("ul",[e("li",[e("div",[e("span",{staticStyle:{"font-weight":"bold"}},[t._v("第一段字符串: HEADER 部分 ")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("内容包括: 算法类型 和 token 类型")])])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#E30000"}},[t._v("{")])],1),e("div",[e("font",{attrs:{color:"#E30000"}},[t._v('  "alg": "HS256", ')]),t._v(" "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 算法类型")])],1),e("div",[e("font",{attrs:{color:"#E30000"}},[t._v('  "typ": "JWT" ')]),t._v(" "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token 类型")])],1),e("div",[e("font",{attrs:{color:"#E30000"}},[t._v("}")])],1)]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("然后，对 HEADER 部分进行 base64url 加密，然后得到第一部分的字符串（密文）")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("ul",[e("li",[e("div",[t._v("base64url 加密是先做 base64加密，然后再将 - 替代 + 及 _ 替代 / 。")])])])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#E30000"}},[t._v("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9")])],1)]),e("div",[e("br")]),e("ul",[e("li",[e("div",[e("span",{staticStyle:{"font-weight":"bold"}},[t._v("第二段字符串: PAYLOAD 部分")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("一般存储着自定义的内容（即: 想返回给前端的内容）")])])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#BA00FF"}},[t._v("{")])],1),e("div",[e("font",{attrs:{color:"#BA00FF"}},[t._v('  "id": "1",')])],1),e("div",[e("font",{attrs:{color:"#BA00FF"}},[t._v('  "name": "Kevin",')])],1),e("div",[e("font",{attrs:{color:"#BA00FF"}},[t._v('  "exp": 1516239022 ')]),t._v(" "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token 的超时时间，一般都要有该属性")])],1),e("div",[e("font",{attrs:{color:"#BA00FF"}},[t._v("  ...")])],1),e("div",[e("font",{attrs:{color:"#BA00FF"}},[t._v("}")])],1)]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("然后，对 PAYLOAD 部分进行 base64url 加密，然后得到第二部分的字符串（密文）")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("ul",[e("li",[e("div",[t._v("base64url 加密是先做 base64加密，然后再将 - 替代 + 及 _ 替代 / 。")])])])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#BA00FF"}},[t._v("eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ")])],1)]),e("div",[e("br")]),e("ul",[e("li",[e("div",[e("span",{staticStyle:{"font-weight":"bold"}},[t._v("第三段字符串: SIGNATURE 部分")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("第一步: 将 "),e("span",{staticStyle:{color:"rgb(227, 0, 0)"}},[t._v("第一段密文 ")]),t._v("和 "),e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("第二段密文 ")]),t._v("用 “.” 拼接起来")])])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("span",{staticStyle:{color:"rgb(227, 0, 0)"}},[t._v("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9")]),t._v("."),e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("第二步: 对第一步拼接后得到的字符串进行 HS256 加密 + 加盐")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("第三步: 对 HS256 加密后的密文再做 base64url 加密，然后得到第三部分的字符串（密文）")])])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#1AADE0"}},[t._v("SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c")])],1)]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("jwt 的源码表现")])])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[t._v("base64url(")]),e("div",[t._v("    HMACSHA256(")]),e("div",[t._v("      base64UrlEncode("),e("font",{attrs:{color:"#E30000"}},[t._v("header")]),t._v(') + "." + base64UrlEncode('),e("font",{attrs:{color:"#BA00FF"}},[t._v("payload")]),t._v("),")],1),e("div",[t._v("      your-256-bit-secret (秘钥加盐)")]),e("div",[t._v("    )")]),e("div",[t._v(")")])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("2.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("以后用户访问接口的时候都需要携带 token 进行访问，然后后端需要对 token 进行校验")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("ul",[e("li",[e("div",[t._v("校验 token 的第一步: 获取 token")])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("span",{staticStyle:{color:"rgb(227, 0, 0)"}},[t._v("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9")]),t._v("."),e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ")]),t._v("."),e("span",{staticStyle:{color:"rgb(26, 173, 224)"}},[t._v("SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c")])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("校验 token 的第二步: 以 “.” 作为分隔符对 token 进行分割")])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[t._v("第一部分:"),e("span",{staticStyle:{color:"rgb(227, 0, 0)"}},[t._v(" eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9")])]),e("div",[e("br")]),e("div",[t._v("第二部分: "),e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ")])]),e("div",[e("br")]),e("div",[t._v("第三部分: "),e("span",{staticStyle:{color:"rgb(26, 173, 224)"}},[t._v("SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c")])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("校验 token 的第三步: 对 token 的第二部分进行 base64url 解密，并获取到 PAYLOAD 信息（即: 自定义的内容信息，返回给前端的内容），然后检测 token 是否过期")])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("{")])]),e("div",[e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v('  "id": "1",')])]),e("div",[e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v('  "name": "Kevin",')])]),e("div",[e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v('  "exp": 1516239022 ')]),t._v(" "),e("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v("# token 的超时时间，一般都要有该属性")])]),e("div",[e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("  ...")])]),e("div",[e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("}")])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("校验 token 的第四步: ")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("第一步: 将 "),e("span",{staticStyle:{color:"rgb(227, 0, 0)"}},[t._v("token 的第一部分字符串")]),t._v(" 和 "),e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("token 的第一部分字符串")]),t._v(" 用 “.” 拼接起来")])])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("span",{staticStyle:{color:"rgb(227, 0, 0)"}},[t._v("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9")]),t._v("."),e("span",{staticStyle:{color:"rgb(186, 0, 255)"}},[t._v("eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("第二步: 对第一步拼接后得到的字符串进行 HS256 加密 + 加盐，得到 密文一")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("第三步: 对 token 的第三部分进行 base64url 解密，得到 密文二")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("第四步: 判断 密文一 和 密文二 是否相等，如果相等，表示 token 未被修改过（认证通过）")])])])]),e("div",[e("br")]),e("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[e("span",{staticStyle:{"font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px",color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5"}},[t._v("JWT 的使用")])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("1.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("JWT 的安装")])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[t._v("pip3 install pyjwt -i https://pypi.douban.com/simple "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 使用豆瓣的镜像")])],1)]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("2.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("JWT 的使用（未对代码进行封装处理）")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# views.py")])],1),e("div",[e("br")]),e("div",[t._v("from rest_framework.views import APIView")]),e("div",[t._v("from rest_framework.response import Response")]),e("div",[t._v("from app01 import models")]),e("div",[t._v("from django.conf import settings")]),e("div",[e("br")]),e("div",[t._v("import "),e("font",{attrs:{color:"#FA7A00"}},[t._v("jwt")])],1),e("div",[t._v("from jwt import "),e("font",{attrs:{color:"#FA7A00"}},[t._v("exceptions")])],1),e("div",[t._v("import datetime")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[t._v("class LoginView(APIView):")]),e("div",[t._v("    def post(self, request):")]),e("div",[t._v("        username = request.data.get('username')")]),e("div",[t._v("        password = request.data.get('password')")]),e("div",[e("br")]),e("div",[t._v("        user_obj = models.UserInfo.objects.filter(username=username, password=password).first()")]),e("div",[e("br")]),e("div",[t._v("        if not user_obj:")]),e("div",[t._v("            return Response({'code': 1000, 'error': '用户名或密码错误'})")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#FA7A00"}},[t._v("# -------------------- 使用 jwt 构造 token -----------------------")])],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 盐")])],1),e("div",[t._v("        SALT = settings.SECRET_KEY")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 构造 header")])],1),e("div",[t._v("        headers = {")]),e("div",[t._v("            'typ': 'jwt',  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token 类型")])],1),e("div",[t._v("            'alg': 'HS256'  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 算法类型")])],1),e("div",[t._v("        }")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 构造 payload")])],1),e("div",[t._v("        payload = {")]),e("div",[t._v("            'user_id': user_obj.pk,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 自定义用户id")])],1),e("div",[t._v("            'username': user_obj.username, "),e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 自定义用户名")])],1),e("div",[t._v("            'exp': datetime.datetime.utcnow() + datetime.timedelta(minutes=1)  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token 超时时间")])],1),e("div",[t._v("        }")]),e("div",[e("br")]),e("div",[t._v("        token = "),e("font",{attrs:{color:"#FA7A00"}},[t._v("jwt.encode")]),t._v("(")],1),e("div",[t._v("            headers=headers,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 头部信息")])],1),e("div",[t._v("            payload=payload, "),e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 自定义内容（即: 返回给前端的内容）")])],1),e("div",[t._v("            key=SALT,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 盐，使用 django 配置文件中的 SECRET_KEY 作为盐")])],1),e("div",[t._v('            algorithm="HS256",  '),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 加密方式")])],1),e("div",[t._v("        ).decode('utf-8')")]),e("div",[e("br")]),e("div",[t._v("        return Response({'code': 1001, 'token': token})")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[t._v("class OrderView(APIView):")]),e("div",[t._v("    def get(self, request):")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#FA7A00"}},[t._v("# -------------------- 使用 jwt 验证 token -----------------------")])],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 从 url 参数中获取 token")])],1),e("div",[t._v("        token = request.query_params.get('token')")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 从 请求头 中获取 token")])],1),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("        #")]),t._v(" token = request.META.get('HTTP_AUTHORIZATION')")],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 盐")])],1),e("div",[t._v("        SALT = settings.SECRET_KEY")]),e("div",[e("br")]),e("div",[t._v("        payload = None")]),e("div",[t._v("        msg = ''")]),e("div",[t._v("        try:")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 验证 token 是否正确，如果 token 校验成功会返回 payload 中的内容（即: 自定义的内容）")])],1),e("div",[t._v("            payload = "),e("font",{attrs:{color:"#FA7A00"}},[t._v("jwt.decode")]),t._v("(token, SALT, True)  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# True 表示进行 token 的校验")])],1),e("div",[t._v("        except exceptions.ExpiredSignatureError:")]),e("div",[t._v("            msg = 'token已失效（已过期）'")]),e("div",[t._v("        except jwt.DecodeError:")]),e("div",[t._v("            msg = 'token认证失败'")]),e("div",[t._v("        except jwt.InvalidTokenError:")]),e("div",[t._v("            msg = '非法的token'")]),e("div",[e("br")]),e("div",[t._v("        if not payload:")]),e("div",[t._v("            return Response({'code': 1002, 'error': msg})")]),e("div",[e("br")]),e("div",[t._v("        return Response({'code': 1003, 'data': payload})")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("img",{attrs:{"data-filename":"Image.png",src:"/kevin-blog/Django/JWT - JSON Web Tokens_files/Image [1].png",type:"image/png"}})])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("img",{attrs:{"data-filename":"Image.png",src:"/kevin-blog/Django/JWT - JSON Web Tokens_files/Image [2].png",type:"image/png"}})])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("3.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("JWT 的使用（对代码进行了封装处理）")])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("获取 token")])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# utils/auth_token.py")])],1),e("div",[e("br")]),e("div",[t._v("import jwt")]),e("div",[t._v("import datetime")]),e("div",[t._v("from django.conf import settings")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[t._v("def get_token(payload, timeout):")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v('"""')])],1),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("    :param payload: 自定义的内容（即: 返回给前端的内容）")])],1),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("    :param timeout: 超时时间")])],1),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("    :return: token")])],1),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v('    """')])],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 盐")])],1),e("div",[t._v("    SALT = settings.SECRET_KEY")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 构造 header")])],1),e("div",[t._v("    headers = {")]),e("div",[t._v("        'typ': 'jwt',  # token 类型")]),e("div",[t._v("        'alg': 'HS256'  # 算法类型")]),e("div",[t._v("    }")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 将超时时间添加到 payload 中")])],1),e("div",[t._v("    payload['exp'] = datetime.datetime.utcnow() + datetime.timedelta(minutes=timeout)  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token 超时时间")])],1),e("div",[e("br")]),e("div",[t._v("    token = jwt.encode(")]),e("div",[t._v("        headers=headers,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 头部信息")])],1),e("div",[t._v("        payload=payload,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 自定义内容（即: 返回给前端的内容）")])],1),e("div",[t._v("        key=SALT,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 盐，使用 django 配置文件中的 SECRET_KEY 作为盐")])],1),e("div",[t._v('        algorithm="HS256",  '),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 加密方式")])],1),e("div",[t._v("    ).decode('utf-8')")]),e("div",[e("br")]),e("div",[t._v("    return token")])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("token 的校验")])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# extensions/auth.py")])],1),e("div",[e("br")]),e("div",[t._v("from rest_framework.authentication import BaseAuthentication")]),e("div",[t._v("from rest_framework import exceptions as rf_exceptions")]),e("div",[e("br")]),e("div",[t._v("import jwt")]),e("div",[t._v("from jwt import exceptions as jwt_exceptions")]),e("div",[t._v("from django.conf import settings")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[t._v("class TokenAuth(BaseAuthentication):")]),e("div",[t._v("    def authenticate(self, request):")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 从 url 参数中获取 token")])],1),e("div",[t._v("        token = request.query_params.get('token')")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 从 请求头 中获取 token")])],1),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# ")]),t._v("token = request.META.get('HTTP_AUTHORIZATION')")],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 盐")])],1),e("div",[t._v("        SALT = settings.SECRET_KEY")]),e("div",[e("br")]),e("div",[t._v("        try:")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 验证 token 是否正确，如果 token 校验成功会返回 payload 中的内容（即: 自定义的内容）")])],1),e("div",[t._v("            payload = jwt.decode(token, SALT, True)  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# True 表示进行 token 的校验")])],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#FA7A00"}},[t._v("return payload, token")])],1),e("div",[e("br")]),e("div",[t._v("        except jwt_exceptions.ExpiredSignatureError:")]),e("div",[t._v("            raise rf_exceptions.AuthenticationFailed({'code': 1003, 'msg': 'token已失效（已过期）'})")]),e("div",[e("br")]),e("div",[t._v("        except jwt.DecodeError:")]),e("div",[t._v("            raise rf_exceptions.AuthenticationFailed({'code': 1004, 'msg': 'token认证失败'})")]),e("div",[e("br")]),e("div",[t._v("        except jwt.InvalidTokenError:")]),e("div",[t._v("            raise rf_exceptions.AuthenticationFailed({'code': 1005, 'msg': '非法的token'})")])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("视图")])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# views.py")])],1),e("div",[e("br")]),e("div",[t._v("from rest_framework.views import APIView")]),e("div",[t._v("from rest_framework.response import Response")]),e("div",[t._v("from app01 import models")]),e("div",[e("br")]),e("div",[t._v("from app01.utils.auth_token import "),e("font",{attrs:{color:"#FA7A00"}},[t._v("get_token")])],1),e("div",[t._v("from app01.extensions.auth import "),e("font",{attrs:{color:"#FA7A00"}},[t._v("TokenAuth")])],1),e("div",[e("br")]),e("div",[e("br")]),e("div",[t._v("class LoginView(APIView):")]),e("div",[t._v("    def post(self, request):")]),e("div",[t._v("        username = request.data.get('username')")]),e("div",[t._v("        password = request.data.get('password')")]),e("div",[e("br")]),e("div",[t._v("        user_obj = models.UserInfo.objects.filter(username=username, password=password).first()")]),e("div",[e("br")]),e("div",[t._v("        if not user_obj:")]),e("div",[t._v("            return Response({'code': 1000, 'error': '用户名或密码错误'})")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 获取 token")])],1),e("div",[t._v("        token = "),e("font",{attrs:{color:"#FA7A00"}},[t._v("get_token")]),t._v("({")],1),e("div",[t._v("            'user_id': user_obj.pk,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 自定义用户id")])],1),e("div",[t._v("            'username': user_obj.username,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 自定义用户名")])],1),e("div",[t._v("        }, 1)")]),e("div",[e("br")]),e("div",[t._v("        return Response({'code': 1001, 'token': token})")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[t._v("class OrderView(APIView):")]),e("div",[t._v("    authentication_classes = ["),e("font",{attrs:{color:"#FA7A00"}},[t._v("TokenAuth")]),t._v("]")],1),e("div",[e("br")]),e("div",[t._v("    def get(self, request):")]),e("div",[t._v("        return Response({")]),e("div",[t._v("            'code': 1006,")]),e("div",[t._v("            'data': {")]),e("div",[t._v("                'user_id': request.user['user_id'],")]),e("div",[t._v("                'username': request.user['username']")]),e("div",[t._v("            }")]),e("div",[t._v("        })")])]),e("div",[e("br")])]),e("div",[e("img",{attrs:{"data-filename":"Image.png",src:"/kevin-blog/Django/JWT - JSON Web Tokens_files/Image [3].png",type:"image/png"}})]),e("div",[e("br")]),e("div",[e("img",{attrs:{"data-filename":"Image.png",src:"/kevin-blog/Django/JWT - JSON Web Tokens_files/Image [4].png",type:"image/png"}})]),e("div",[e("br")]),e("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[e("span",{staticStyle:{"font-size":"21px",color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5"}},[t._v("JWT 刷新 Token 的思路与实现")])]),e("div",[e("br")]),e("div",[e("a",{attrs:{href:"/kevin-blog/Django/JWT - JSON Web Tokens_files/auto_jwt_demo.rar"}},[e("img",{attrs:{alt:"auto_jwt_demo.rar",src:"/kevin-blog/Django/JWT - JSON Web Tokens_files/8a056c946241bd8085d950823549608c.png"}})])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("1.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("思路")])]),e("div",[e("span",{staticStyle:{"font-size":"14pt"}},[e("br")])]),e("ul",[e("li",[e("div",[t._v("准备两个 token")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("token（过期时间短） -> 用于平常的验证过期")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("refresh_token（过期时间长） -> refresh_token 用于当 token 过期时，换取新的 token 值，以及一个新的 refresh_token 值")])])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("当客户端在发送请求前，需要检测 token 是否过期")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("情况一: 当 token 没有过期，继续发送请求")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("情况二: 当 token 已过期，发送刷新 token 的请求，根据返回的状态码进行判断是否继续请求或重新登陆")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("ul",[e("li",[e("div",[t._v("① 如果后端检测 refresh_token 正确且没有过期，返回正确的状态码，然后前端更新 Vuex 中的 token 继续发送请求")])])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("ul",[e("li",[e("div",[t._v("② 如果后端检测 refresh_token 错误或者过期，返回错确的状态码，然后前端需要重新登陆获取 token")])])])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("当服务端接收到 token 时")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("情况一: 当 token 正确且没有过期，返回对应的数据信息")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("情况二: 当 token 错误或者过期，返回错误的数据信息")])])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("当服务端刷新 token 是")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("情况一: 当 refresh_token 正确且没有过期，返回新的 token、refresh_token、token 过期时间 ")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("情况二: 当 refresh_token 错误或者过期，返回错误的数据信息")])])])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("2.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("后端")]),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("实现")])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("获取 token 和 token 过期时间")])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# utils/auth_token.py")])],1),e("div",[e("br")]),e("div",[t._v("import jwt")]),e("div",[t._v("import datetime")]),e("div",[t._v("from django.conf import settings")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[t._v("class MyToken(object):")]),e("div",[t._v("    def __init__(self):")]),e("div",[t._v("        self.typ = 'jwt'  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token 类型")])],1),e("div",[t._v('        self.alg = "HS256"  '),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 算法类型")])],1),e("div",[t._v("        self.SALT = settings.SECRET_KEY  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 盐，使用 django 配置文件中的 SECRET_KEY 作为盐")])],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 获取 token 超时时间")])],1),e("div",[t._v("    def get_token_time(self, time_type, exp, is_utc=True):")]),e("div",[t._v("        if is_utc:")]),e("div",[t._v("            not_time = datetime.datetime.utcnow()")]),e("div",[t._v("        else:")]),e("div",[t._v("            not_time = datetime.datetime.now()")]),e("div",[t._v("        if time_type == 'days':")]),e("div",[t._v("            return not_time + datetime.timedelta(days=exp)")]),e("div",[t._v("        elif time_type == 'hours':")]),e("div",[t._v("            return not_time + datetime.timedelta(hours=exp)")]),e("div",[t._v("        elif time_type == 'minutes':")]),e("div",[t._v("            return not_time + datetime.timedelta(minutes=exp)")]),e("div",[t._v("        elif time_type == 'seconds':")]),e("div",[t._v("            return not_time + datetime.timedelta(seconds=exp)")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 获取 token 信息（包括: token、token 过期时间）")])],1),e("div",[t._v("    def get_token_info(self, payload, time_type, exp):")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 构造 header")])],1),e("div",[t._v("        headers = {")]),e("div",[t._v("            'typ': self.typ,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token 类型")])],1),e("div",[t._v("            'alg': self.alg  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 算法类型")])],1),e("div",[t._v("        }")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 将超时时间添加到 payload 中")])],1),e("div",[t._v("        payload['exp'] = self.get_token_time(time_type, exp)  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token 超时时间")])],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 获取不是 utc 的 token 超时时间")])],1),e("div",[t._v("        token_time = self.get_token_time(time_type, exp, is_utc=False)")]),e("div",[e("br")]),e("div",[t._v("        token = jwt.encode(")]),e("div",[t._v("            headers=headers,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 头部信息")])],1),e("div",[t._v("            payload=payload,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 自定义内容（即: 返回给前端的内容）")])],1),e("div",[t._v("            key=self.SALT,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 盐，使用 django 配置文件中的 SECRET_KEY 作为盐")])],1),e("div",[t._v("            algorithm=self.alg,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 加密方式")])],1),e("div",[t._v("        ).decode('utf-8')")]),e("div",[e("br")]),e("div",[t._v("        return {")]),e("div",[t._v("            'token': token,  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token")])],1),e("div",[t._v("            'token_time': token_time  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# token 过期时间")])],1),e("div",[t._v("        }")])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("token 的校验")])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v("# extensions/auth.py")])]),e("div",[e("br")]),e("div",[t._v("from rest_framework.authentication import BaseAuthentication")]),e("div",[t._v("from rest_framework import exceptions as rf_exceptions")]),e("div",[e("br")]),e("div",[t._v("import jwt")]),e("div",[t._v("from jwt import exceptions as jwt_exceptions")]),e("div",[t._v("from django.conf import settings")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[t._v("class TokenAuth(BaseAuthentication):")]),e("div",[t._v("    def authenticate(self, request):")]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v(" # 从 url 参数中获取 token")])]),e("div",[t._v("        token = request.query_params.get('token')")]),e("div",[e("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v("# 从 请求头 中获取 token")])]),e("div",[e("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v("# ")]),t._v("token = request.META.get('HTTP_AUTHORIZATION')")]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v("# 盐")])]),e("div",[t._v("        SALT = settings.SECRET_KEY")]),e("div",[e("br")]),e("div",[t._v("        try:")]),e("div",[e("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v("# 验证 token 是否正确，如果 token 校验成功会返回 payload 中的内容（即: 自定义的内容）")])]),e("div",[t._v("            payload = jwt.decode(token, SALT, True)  "),e("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v("# True 表示进行 token 的校验")])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{color:"rgb(250, 122, 0)"}},[t._v("return payload, token")])]),e("div",[e("br")]),e("div",[t._v("        except jwt_exceptions.ExpiredSignatureError:")]),e("div",[t._v("            raise rf_exceptions.AuthenticationFailed({'code': 1003, 'msg': 'token已失效（已过期）'})")]),e("div",[e("br")]),e("div",[t._v("        except jwt.DecodeError:")]),e("div",[t._v("            raise rf_exceptions.AuthenticationFailed({'code': 1004, 'msg': 'token认证失败'})")]),e("div",[e("br")]),e("div",[t._v("        except jwt.InvalidTokenError:")]),e("div",[t._v("            raise rf_exceptions.AuthenticationFailed({'code': 1005, 'msg': '非法的token'})")])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("视图")])])]),e("div",[e("br")])]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("span",{staticStyle:{"font-size":"9pt","font-family":"Monaco"}},[e("font",{attrs:{color:"#41AD1C"}},[t._v("# views.py")])],1)]),e("div",[e("span",{staticStyle:{"font-size":"9pt",color:"rgb(51, 51, 51)","font-family":"Monaco"}},[e("br")])]),e("div",[t._v("from rest_framework.views import APIView")]),e("div",[t._v("from rest_framework.response import Response")]),e("div",[t._v("from api import models")]),e("div",[e("br")]),e("div",[t._v("from api.utils.auth_token import MyToken")]),e("div",[t._v("from api.extensions.auth import TokenAuth")]),e("div",[e("br")]),e("div",[t._v("import jwt")]),e("div",[t._v("from jwt import exceptions")]),e("div",[t._v("from django.conf import settings")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 登陆")])],1),e("div",[t._v("class LoginView(APIView):")]),e("div",[t._v("    def post(self, request):")]),e("div",[t._v("        username = request.data.get('username')")]),e("div",[t._v("        password = request.data.get('password')")]),e("div",[e("br")]),e("div",[t._v("        user_obj = models.UserInfo.objects.filter(username=username, password=password).first()")]),e("div",[e("br")]),e("div",[t._v("        if not user_obj:")]),e("div",[t._v("            return Response({'code': 1000, 'error': '用户名或密码错误'})")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 获取 token")])],1),e("div",[t._v("        my_token = MyToken()")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 短时间的 token，用于校验 token")])],1),e("div",[t._v("        token_info = my_token.get_token_info(")]),e("div",[t._v("            payload={")]),e("div",[t._v("                'user_id': user_obj.pk,  # 自定义用户id")]),e("div",[t._v("                'username': user_obj.username,  # 自定义用户名")]),e("div",[t._v("            },")]),e("div",[t._v("            time_type='seconds',")]),e("div",[t._v("            exp=3")]),e("div",[t._v("        )")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 长时间的 token，用于更新 token")])],1),e("div",[t._v("        refresh_token_info = my_token.get_token_info(")]),e("div",[t._v("            payload={")]),e("div",[t._v("                'user_id': user_obj.pk,  # 自定义用户id")]),e("div",[t._v("                'username': user_obj.username,  # 自定义用户名")]),e("div",[t._v("            },")]),e("div",[t._v("            time_type='seconds',")]),e("div",[t._v("            exp=5")]),e("div",[t._v("        )")]),e("div",[e("br")]),e("div",[t._v("        return Response({'code': 1001, 'data': {")]),e("div",[t._v("            'token': token_info['token'],")]),e("div",[t._v("            'refresh_token': refresh_token_info['token'],")]),e("div",[t._v("            'token_time': token_info['token_time'],")]),e("div",[t._v("        '+'}'+'}'}})")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 更新 Token")])],1),e("div",[t._v("class UpdateTokenView(APIView):")]),e("div",[t._v("    def post(self, request):")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 获取请求头中 token")])],1),e("div",[t._v("        refresh_token = request.META.get('HTTP_REFRESHAUTHORIZATION')")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 盐")])],1),e("div",[t._v("        SALT = settings.SECRET_KEY")]),e("div",[e("br")]),e("div",[t._v("        payload = None")]),e("div",[t._v("        msg = ''")]),e("div",[e("br")]),e("div",[t._v("        try:")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 验证 token 是否正确，如果 token 校验成功会返回 payload 中的内容（即: 自定义的内容）")])],1),e("div",[t._v("            payload = jwt.decode(refresh_token, SALT, True)  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# True 表示进行 token 的校验")])],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 获取 token")])],1),e("div",[t._v("            my_token = MyToken()")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 短时间的 token，用于校验 token")])],1),e("div",[t._v("            token_info = my_token.get_token_info(")]),e("div",[t._v("                payload={")]),e("div",[t._v("                    'user_id': payload['user_id'],  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 自定义用户id")])],1),e("div",[t._v("                    'username': payload['username'],  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 自定义用户名")])],1),e("div",[t._v("                },")]),e("div",[t._v("                time_type='seconds',")]),e("div",[t._v("                exp=3")]),e("div",[t._v("            )")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" # 长时间的 token，用于更新 token")])],1),e("div",[t._v("            refresh_token_info = my_token.get_token_info(")]),e("div",[t._v("                payload={")]),e("div",[t._v("                    'user_id': payload['user_id'],  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 自定义用户id")])],1),e("div",[t._v("                    'username': payload['username'],  "),e("font",{attrs:{color:"#41AD1C"}},[t._v("# 自定义用户名")])],1),e("div",[t._v("                },")]),e("div",[t._v("                time_type='seconds',")]),e("div",[t._v("                exp=5")]),e("div",[t._v("            )")]),e("div",[e("br")]),e("div",[t._v("            return Response({")]),e("div",[t._v("                'code': 1007,")]),e("div",[t._v("                'data': {")]),e("div",[t._v("                    'token': token_info['token'],")]),e("div",[t._v("                    'refresh_token': refresh_token_info['token'],")]),e("div",[t._v("                    'token_time': token_info['token_time'],")]),e("div",[t._v("                }")]),e("div",[t._v("            })")]),e("div",[e("br")]),e("div",[t._v("        except exceptions.ExpiredSignatureError:")]),e("div",[t._v("            msg = 'token已失效（已过期）'")]),e("div",[t._v("        except jwt.DecodeError:")]),e("div",[t._v("            msg = 'token认证失败'")]),e("div",[t._v("        except jwt.InvalidTokenError:")]),e("div",[t._v("            msg = '非法的token'")]),e("div",[e("br")]),e("div",[t._v("        if not payload:")]),e("div",[t._v("            return Response({'code': 1008, 'error': msg})")]),e("div",[e("br")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# 订单")])],1),e("div",[t._v("class OrderView(APIView):")]),e("div",[t._v("    authentication_classes = [TokenAuth]")]),e("div",[e("br")]),e("div",[t._v("    def get(self, request):")]),e("div",[t._v("        return Response({")]),e("div",[t._v("            'code': 1006,")]),e("div",[t._v("            'data': '订单数据'")]),e("div",[t._v("        })")])]),e("div",[e("br")]),e("div",[e("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("2.")]),t._v(" "),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("前端")]),e("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("实现（Vue）")])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("通过 axios 拦截器进行实现，在每次请求前验证 token 是否过期，如果已过期那么就刷新 token 后再发送请求")])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("注意: 如果出现了跨域问题，一定要用前端方法进行解决，不要使用后端方法进行解决，否则会没有效果")])])]),e("div",[e("br")]),e("ul",[e("li",[e("div",[t._v("使用前需要修改的地方")])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("拦截器中的白名单")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("拦截器中的刷新token的请求网址")])])])]),e("div",[e("br")]),e("ul",[e("ul",[e("li",[e("div",[t._v("拦截器中刷新token请求成功后返回的状态码")])])])]),e("div",[e("br")]),e("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("# src/api/ajax.js")])],1),e("div",[e("br")]),e("div",[t._v("import axios from 'axios'")]),e("div",[t._v("import store from '../store'")]),e("div",[t._v("import this_vue from '../main'")]),e("div",[t._v('import {RECEIVE_TOKEN} from "../store/mutations-types";')]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("// axios.defaults.baseURL = 'http://127.0.0.1:8010/api';")])],1),e("div",[t._v("axios.defaults.baseURL = `./api`;")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("// axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';")])],1),e("div",[e("br")]),e("div",[t._v('export default function (url, data = {}, type = "GET") {')]),e("div",[t._v("    return new Promise((resolve, reject) => {")]),e("div",[t._v("        let promise;")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}}),e("font",{attrs:{color:"#FA7A00"}},[t._v("// 获取token的相关信息")])],1),e("div",[t._v("        const token = store.state.token;")]),e("div",[t._v("        const refresh_token = store.state.refresh_token;")]),e("div",[t._v("        const token_time = store.state.token_time;")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}}),e("font",{attrs:{color:"#FA7A00"}},[t._v("// axios 取消请求的相关参数")])],1),e("div",[t._v("        const CancelToken = axios.CancelToken;")]),e("div",[t._v("        const source = CancelToken.source();")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}}),e("font",{attrs:{color:"#FA7A00"}},[t._v("// 每次请求都携带token")])],1),e("div",[t._v("        axios.defaults.headers.common['Authorization'] = token;")]),e("div",[t._v("        axios.defaults.headers.common['RefreshAuthorization'] = refresh_token;")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#FA7A00"}},[t._v("// axios 请求拦截器")])],1),e("div",[t._v("        let myInterceptor = axios.interceptors.request.use(async config => {")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("// 白名单")])],1),e("div",[t._v("            let whitelist = [")]),e("div",[t._v("                '/login/',")]),e("div",[t._v("                '/update_token/',")]),e("div",[t._v("            ];")]),e("div",[e("br")]),e("div",[t._v("            if (token && whitelist.indexOf(config.url) == -1) {")]),e("div",[e("br")]),e("div",[t._v("                let token_time_obj = new Date(token_time); "),e("font",{attrs:{color:"#41AD1C"}},[t._v("// token 过期时间的时间戳")])],1),e("div",[t._v("                let this_time_obj = new Date(); "),e("font",{attrs:{color:"#41AD1C"}},[t._v("// 当前时间的时间戳")])],1),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("// 如果当前时间大于token过期时间那么就刷新 token")])],1),e("div",[t._v("                if (token_time_obj.getTime() < this_time_obj.getTime()) {")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("// 请求刷新 token 的接口")])],1),e("div",[t._v("                    let response = await axios.post('/update_token/');")]),e("div",[t._v("                    let res = response.data;")]),e("div",[t._v("                    if (res.code == '1007') {")]),e("div",[t._v("                        this_vue.$store.commit(RECEIVE_TOKEN, {")]),e("div",[t._v("                            token: res.data.token,")]),e("div",[t._v("                            refresh_token: res.data.refresh_token,")]),e("div",[t._v("                            token_time: res.data.token_time")]),e("div",[t._v("                        });")]),e("div",[t._v("                        config.headers.Authorization = res.data.token;")]),e("div",[t._v("                        config.headers.RefreshAuthorization = res.data.refresh_token;")]),e("div",[t._v("                        return config;")]),e("div",[t._v("                    } else {")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v("// 如果连 refresh_token 都过期，那么就需要重新登陆")])],1),e("div",[t._v("                        config.cancelToken = source.token;")]),e("div",[t._v("                        source.cancel('token已过期，请重新登陆');")]),e("div",[t._v("                        this_vue.$router.replace({path: 'login'});")]),e("div",[t._v("                        return config")]),e("div",[t._v("                    }")]),e("div",[t._v("                } else {")]),e("div",[t._v("                    return config;")]),e("div",[t._v("                }")]),e("div",[t._v("            } else {")]),e("div",[t._v("                return config;")]),e("div",[t._v("            }")]),e("div",[e("br")]),e("div",[t._v("        }, error => {")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" // 对请求错误做些什么")])],1),e("div",[t._v("            return Promise.reject(error);")]),e("div",[t._v("        });")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#41AD1C"}},[t._v(" // 请求")])],1),e("div",[t._v("        if (type === 'GET') {")]),e("div",[t._v("            let dataStr = '';")]),e("div",[t._v("            Object.keys(data).forEach(key => {")]),e("div",[t._v("                dataStr += key + '=' + data[key] + '&';")]),e("div",[t._v("            });")]),e("div",[t._v("            if (dataStr !== '') {")]),e("div",[t._v("                dataStr = dataStr.substring(0, dataStr.lastIndexOf('&'));")]),e("div",[t._v("                url += '?' + dataStr;")]),e("div",[t._v("            }")]),e("div",[t._v("            promise = axios.get(url)")]),e("div",[t._v("        } else {")]),e("div",[t._v("            let type_lower = type.toLowerCase();")]),e("div",[t._v("            promise = axios[type_lower](url, data)")]),e("div",[t._v("        }")]),e("div",[e("br")]),e("div",[e("font",{attrs:{color:"#FA7A00"}},[t._v("// 移除 axios 拦截器")])],1),e("div",[t._v("        axios.interceptors.request.eject(myInterceptor);")]),e("div",[e("br")]),e("div",[t._v("        promise.then((response) => {")]),e("div",[t._v("            resolve(response.data);")]),e("div",[t._v("        }).catch((error) => {")]),e("div",[t._v("            resolve(error);")]),e("div",[t._v("        })")]),e("div",[t._v("    });")]),e("div",[t._v("}")])]),e("div",[e("br")]),e("div",[e("br")]),e("div",[e("br")])]),e("div",[e("br")])])])])}),[],!1,null,null,null);o.default=r.exports}}]);