(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{378:function(t,o,r){"use strict";r.r(o);var e=r(25),i=Object(e.a)({},(function(){var t=this,o=t.$createElement,r=t._self._c||o;return r("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[r("div",[r("span",[r("div",[r("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[r("span",{staticStyle:{"font-size":"21px"}}),r("span",{staticStyle:{"font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px",color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5"}},[t._v("锁")])]),r("div",[r("br")]),r("div",[r("font",{staticStyle:{"font-size":"14pt"}},[t._v("锁，一般和事务搭配着使用")])],1),r("div",[r("br")]),r("div",[r("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("1.")]),t._v(" "),r("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("行级锁")])]),r("div",[r("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[r("br")])]),r("ul",[r("li",[r("div",[r("font",{staticStyle:{"font-size":"12pt"}},[t._v("基于数据行")])],1)])]),r("div",[r("br")]),r("ul",[r("li",[r("div",[t._v("通俗理解: 每一次只允许一个用户对该条数据进行修改，在orm中只有当事务执行完，锁才会被释放（在SQL中只能手动释放锁），下一个用户才能修改该条数据")])])]),r("div",[r("br")]),r("ul",[r("li",[r("div",[t._v("行级锁，一般都会在查询数据的时候上锁")])])]),r("div",[r("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[r("br")])]),r("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("# .select_for_update() 上行级锁")])],1),r("div",[r("br")]),r("div",[t._v("book_list = Book.objects.filter(price__gt=50).select_for_update()  "),r("font",{attrs:{color:"#41AD1C"}},[t._v("# 对查询到的数据上锁，每一次只允许一个用户对该条数据进行修改")])],1),r("div",[t._v("book_list.update(price=100)  "),r("font",{attrs:{color:"#41AD1C"}},[t._v("# 批量更新数据")])],1)]),r("div",[r("br")]),r("div",[r("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[t._v("2.")]),t._v(" "),r("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[t._v("表锁 -> 了解即可")])]),r("div",[r("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[r("br")])]),r("ul",[r("li",[r("div",[r("font",{staticStyle:{"font-size":"12pt"}},[t._v("基于表")])],1)])]),r("div",[r("br")]),r("ul",[r("li",[r("div",[t._v("通俗理解: 每一次只允许一个用户对该表进行操作，在orm中只有当事务执行完，锁才会被释放（在SQL中只能手动释放锁），下一个用户才能操作该表")])])]),r("div",[r("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[r("br")])]),r("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[r("div",[t._v("class LockingManager(models.Manager):")]),r("div",[r("br")]),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v('    """ Add lock/unlock functionality to manager.')])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("    Example::")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("        class Job(models.Model):")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("            manager = LockingManager()")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("            counter = models.IntegerField(null=True, default=0)")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("            @staticmethod")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("            def do_atomic_update(job_id)")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                ''' Updates job integer, keeping it below 5 '''")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                try:")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                    # Ensure only one HTTP request can do this update at once.")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                    Job.objects.lock()")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                    job = Job.object.get(id=job_id)")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                    # If we don't lock the tables two simultanous")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                    # requests might both increase the counter")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                    # going over 5")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                    if job.counter < 5:")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                        job.counter += 1                                        ")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                        job.save()")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                finally:")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("                    Job.objects.unlock()")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v('    """    ')])],1),r("div",[r("br")]),r("div",[t._v("    def lock(self):")]),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v('""" Lock table.')])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("        Locks the object model table so that atomic update is possible.")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("        Simulatenous database access request pend until the lock is unlock()'ed.")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("        Note: If you need to lock multiple tables, you need to do lock them")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("        all in one SQL clause and this function is not enough. To avoid")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("        dead lock, all tables must be locked in the same order.")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[r("br")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v("        See http://dev.mysql.com/doc/refman/5.0/en/lock-tables.html")])],1),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v('        """')])],1),r("div",[t._v("        cursor = connection.cursor()")]),r("div",[t._v("        table = self.model._meta.db_table")]),r("div",[t._v('        logger.debug("Locking table %s" % table)')]),r("div",[t._v('        cursor.execute("LOCK TABLES %s WRITE" % table)')]),r("div",[t._v("        row = cursor.fetchone()")]),r("div",[t._v("        return row")]),r("div",[r("br")]),r("div",[t._v("    def unlock(self):")]),r("div",[r("font",{attrs:{color:"#41AD1C"}},[t._v('""" Unlock the table. """')])],1),r("div",[t._v("        cursor = connection.cursor()")]),r("div",[t._v("        table = self.model._meta.db_table")]),r("div",[t._v('        cursor.execute("UNLOCK TABLES")')]),r("div",[t._v("        row = cursor.fetchone()")]),r("div",[t._v("        return row  ")])]),r("div",[r("br")]),r("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[r("span",{staticStyle:{"font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px",color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5"}},[t._v("事务")])]),r("div",[r("br")]),r("ul",[r("li",[r("div",[t._v("这里的事务和MySQL中的一样，当发生了错误就回滚到最初状态，不懂的可以看回Mysql中的事务（表操作 -> innodb引擎）")])])]),r("div",[r("br")]),r("ul",[r("li",[r("div",[t._v("导入事务模块")])])]),r("div",[r("br")]),r("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[r("div",[t._v("from django.db import transaction")])]),r("div",[r("br")]),r("ul",[r("li",[r("div",[t._v("事务的使用")])])]),r("div",[r("br")]),r("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[r("div",[r("span",{staticStyle:{"font-size":"9pt","font-family":"Monaco",color:"rgb(65, 173, 28)"}},[t._v("# 固定写法")])]),r("div",[r("br")]),r("div",[t._v("import datetime")]),r("div",[t._v("from app01 import models")]),r("div",[t._v("from django.db import transaction")]),r("div",[t._v("try:")]),r("div",[t._v("    with transaction.atomic():")]),r("div",[r("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v("# 查询语句")])]),r("div",[t._v("except Exception as e:")]),r("div",[t._v("    print(str(e))")])]),r("div",[r("br")]),r("ul",[r("li",[r("div",[t._v("with transaction.atomic() 里面所写的代码发生报错，所有的东西都会回滚到最初的状态，例如: '火星出版社' 不会被添加到数据库中")])])]),r("div",[r("br")]),r("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[r("div",[t._v("import datetime")]),r("div",[t._v("from app01 import models")]),r("div",[t._v("from django.db import transaction")]),r("div",[t._v("try:")]),r("div",[t._v("    with transaction.atomic():")]),r("div",[t._v('        new_publisher = models.Publisher.objects.create(name="火星出版社")')]),r("div",[t._v('        models.Book.objects.create(title="橘子物语", publish_date=datetime.date.today(), publisher_id=10)  '),r("span",{staticStyle:{color:"rgb(65, 173, 28)"}},[t._v("# 指定一个不存在的出版社id")])]),r("div",[t._v("except Exception as e:")]),r("div",[t._v("    print(str(e))")])]),r("div",[r("br")]),r("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[r("span",{staticStyle:{"font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}}),r("span",{staticStyle:{"font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px",color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5"}},[t._v("事务和锁搭配使用")])]),r("div",[r("br")]),r("ul",[r("li",[r("div",[t._v("只有当事务执行完后，锁才会被释放")])])]),r("div",[r("br")]),r("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[r("div",[t._v("import time")]),r("div",[t._v("from app01.models import *")]),r("div",[t._v("from django.db import transaction")]),r("div",[r("br")]),r("div",[t._v("try:")]),r("div",[t._v("    with transaction.atomic():")]),r("div",[t._v("        time.sleep(5)  "),r("font",{attrs:{color:"#41AD1C"}},[t._v("# 延时5秒执行下方代码")])],1),r("div",[t._v("        book_list = Book.objects.filter(price__gt=50).select_for_update()  "),r("font",{attrs:{color:"#41AD1C"}},[t._v("# 对查询到的数据上锁，每一次只允许一个用户对该条数据进行修改")])],1),r("div",[t._v("        book_list.update(price=100)  "),r("font",{attrs:{color:"#41AD1C"}},[t._v("# 批量更新数据")])],1),r("div",[t._v("except Exception as e:")]),r("div",[t._v("    print(str(e))")])]),r("div",[r("br")]),r("div",[r("br")]),r("div",[r("br")])]),r("div",[r("br")])])])])}),[],!1,null,null,null);o.default=i.exports}}]);