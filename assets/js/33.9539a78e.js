(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{385:function(e,t,o){"use strict";o.r(t);var r=o(25),i=Object(r.a)({},(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("div",[o("span",[o("div",[o("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[o("span",{staticStyle:{"font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px",color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5"}},[e._v("简单版的 Token认证")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("span",{staticStyle:{"font-size":"9pt","font-family":"Monaco"}},[o("font",{attrs:{color:"#41AD1C"}},[e._v("# auth.py")])],1)]),o("div",[o("span",{staticStyle:{"font-size":"9pt",color:"rgb(51, 51, 51)","font-family":"Monaco"}},[o("br")])]),o("div",[e._v("from rest_framework.authentication import BaseAuthentication")]),o("div",[e._v("from rest_framework.exceptions import AuthenticationFailed")]),o("div",[e._v("from api.models import *")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class TokenAuth(BaseAuthentication):")]),o("div",[e._v("    def authenticate(self, request):")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# token = request.data.get('token')")]),e._v(" "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 从请求体中获取token参数")])],1),o("div",[e._v("        token = request.META.get('HTTP_AUTHORIZATION') "),o("font",{attrs:{color:"#41AD1C"}},[e._v(" # 从请求头中获取token参数")])],1),o("div",[e._v("        token_obj = UserToken.objects.filter(token=token).first()")]),o("div",[e._v("        if not token_obj:")]),o("div",[e._v("            raise AuthenticationFailed({'code': 0, 'error': '认证失败'})")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# return '', None")])],1),o("div",[e._v("        return token_obj.user, token_obj")])]),o("div",[o("br")]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# views.py")])],1),o("div",[o("br")]),o("div",[e._v("from rest_framework.views import APIView")]),o("div",[e._v("from rest_framework.response import Response")]),o("div",[e._v("from api.models import *")]),o("div",[o("br")]),o("div",[e._v("from api.utils.auth import TokenAuth")]),o("div",[o("br")]),o("div",[e._v("import uuid")]),o("div",[e._v("import datetime")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 初始化返回值")])],1),o("div",[e._v("class BaseResponse:")]),o("div",[e._v("    def __init__(self):")]),o("div",[e._v("        self.code = ''")]),o("div",[e._v("        self.status = False")]),o("div",[e._v("        self.data = None")]),o("div",[e._v("        self.msg = ''")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("    @property")]),o("div",[e._v("    def dic(self):")]),o("div",[e._v("        return self.__dict__")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 登陆，写入token")])],1),o("div",[e._v("class LoginView(APIView):")]),o("div",[e._v("    def post(self, request, *args, **kwargs):")]),o("div",[e._v("        res = BaseResponse()")]),o("div",[e._v("        try:")]),o("div",[e._v("            username = request.data.get('username')")]),o("div",[e._v("            password = request.data.get('password')")]),o("div",[e._v("            user = UserInfo.objects.filter(username=username, password=password).first()")]),o("div",[e._v("            if user:")]),o("div",[e._v("                uid = uuid.uuid4()")]),o("div",[e._v("                UserToken.objects.update_or_create(user=user, defaults={'token': uid, 'created': datetime.datetime.now()})")]),o("div",[e._v("                res.status = True")]),o("div",[e._v("                res.data = {")]),o("div",[e._v("                    'token': uid")]),o("div",[e._v("                }")]),o("div",[e._v("                res.msg = '登陆成功'")]),o("div",[e._v("        except Exception as e:")]),o("div",[e._v("            res.code = 1000")]),o("div",[e._v("            res.msg = '登陆失败'")]),o("div",[e._v("        return Response(res.dic)")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 测试认证")])],1),o("div",[e._v("class IndexView(APIView):")]),o("div",[e._v("    authentication_classes = [TokenAuth]")]),o("div",[o("br")]),o("div",[e._v("    def get(self, request, *args, **kwargs):")]),o("div",[e._v("        res = BaseResponse()")]),o("div",[e._v("        res.status = True")]),o("div",[e._v("        res.data = {'username': request.user.username}")]),o("div",[e._v("        return Response(res.dic)")])]),o("div",[o("br")]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# models.py")])],1),o("div",[o("br")]),o("div",[e._v("from django.db import models")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class UserInfo(models.Model):")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v('"""')])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("    用户表")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v('    """')])],1),o("div",[e._v("    username = models.CharField(verbose_name='用户名', max_length=32)")]),o("div",[e._v("    password = models.CharField(verbose_name='密码', max_length=32)")]),o("div",[o("br")]),o("div",[e._v("    class Meta:")]),o("div",[e._v('        verbose_name = "用户表"')]),o("div",[e._v("        verbose_name_plural = verbose_name")]),o("div",[o("br")]),o("div",[e._v("    def __str__(self):")]),o("div",[e._v("        return self.username")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class UserToken(models.Model):")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v('"""')])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("    用户token表")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v('    """')])],1),o("div",[e._v("    user = models.OneToOneField(to='UserInfo')")]),o("div",[e._v("    token = models.CharField(verbose_name='token', max_length=64)")]),o("div",[e._v('    created = models.DateTimeField(verbose_name="创建时间", auto_now_add=True)')]),o("div",[o("br")]),o("div",[e._v("    class Meta:")]),o("div",[e._v('        verbose_name = "用户Token表"')]),o("div",[e._v("        verbose_name_plural = verbose_name")])]),o("div",[o("br")]),o("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[o("span",{staticStyle:{"font-size":"21px","background-color":"#3eaf7c","border-radius":"3px","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px",color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5"}},[e._v("复杂版的 Token认证")])]),o("div",[o("br")]),o("ul",[o("li",[o("div",[o("span",{staticStyle:{"font-size":"12pt"}},[e._v("功能描述: 缓存token（即: 不用每次从数据库中获取token进行比较） + 超时token")])])])]),o("div",[o("br")]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# auth.py")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[o("br")])],1),o("div",[e._v("from rest_framework.authentication import BaseAuthentication")]),o("div",[e._v("from rest_framework.exceptions import AuthenticationFailed")]),o("div",[e._v("from api.models import *")]),o("div",[o("br")]),o("div",[e._v("from django.core.cache import cache")]),o("div",[o("br")]),o("div",[e._v("import datetime")]),o("div",[e._v("import pytz")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class TokenAuth(BaseAuthentication):")]),o("div",[e._v("    def authenticate(self, request):")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# token = request.data.get('token')  # 从请求体中获取token参数")])],1),o("div",[e._v("        token = request.META.get('HTTP_AUTHORIZATION')  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 从请求头中获取token参数")])],1),o("div",[o("br")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 从缓存中获取以token为key的缓存内容")])],1),o("div",[e._v("        user = cache.get(token)")]),o("div",[e._v("        if user:")]),o("div",[e._v("            return user, token")]),o("div",[o("br")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 数据库验证：如果缓存中没有token，那么就使用数据库验证")])],1),o("div",[e._v("        token_obj = UserToken.objects.filter(token=token).first()")]),o("div",[e._v("        if not token_obj:")]),o("div",[e._v("            raise AuthenticationFailed({'code': 0, 'error': '认证失败'})")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# return '', None")])],1),o("div",[o("br")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 验证token是否在有效期内")])],1),o("div",[e._v("        now_time = datetime.datetime.now()")]),o("div",[e._v("        now_time = now_time.replace(tzinfo=pytz.timezone('UTC'))  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 因为.now()默认获取是不带时区的时间，而从数据库中获取的是带时区的时间所以要给.now()添加上时区")])],1),o("div",[e._v("        create_time = token_obj.created")]),o("div",[e._v("        delta = now_time - create_time  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 相差时间")])],1),o("div",[o("br")]),o("div",[e._v("        if delta < datetime.timedelta(weeks=2):  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 当前时间是否小于两周的时间")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 校验成功，写入数据库")])],1),o("div",[e._v("            delta = datetime.timedelta(weeks=2) - delta  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# token 剩余时间")])],1),o("div",[e._v("            cache.set(token_obj.token, token_obj.user, min(delta.total_seconds(), 60 * 60 * 24 * 7))  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# delta.total_seconds():获取实际的秒数，如果剩余时间超过7天，那么就使用7时间，如果没有则使用剩余的时间，这里的时间不能是写死的")])],1),o("div",[e._v("        else:")]),o("div",[e._v("            raise AuthenticationFailed({'code': 0, 'error': 'token超时'})")]),o("div",[o("br")]),o("div",[e._v("        return token_obj.user, token_obj")])]),o("div",[o("br")]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# views.py")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[o("br")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 这里的代码就是简单版的token认证中的 views.py 代码")])],1)]),o("div",[o("br")]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# models.py")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[o("br")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 这里的代码就是简单版的token认证中的 models.py 代码")])],1)]),o("div",[o("br")]),o("h2",{staticStyle:{margin:"10px 0px 12px",padding:"0px 0px 0px 15px","background-color":"#3eaf7c","border-radius":"3px","text-align":"center","text-shadow":"rgb(34, 34, 34) 1px 1px 2px","letter-spacing":"normal",orphans:"2","text-indent":"0px","text-transform":"none","white-space":"normal",widows:"2","word-spacing":"0px","-webkit-text-stroke-width":"0px"}},[o("span",{staticStyle:{color:"white","font-family":'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif',"font-variant-caps":"normal","font-variant-ligatures":"normal","font-weight":"bold","line-height":"1.5","font-size":"16pt"}},[e._v("JsonWebToken（简称: JWT） Token认证")])]),o("div",[o("br")]),o("div",[o("span",{staticStyle:{color:"rgb(255, 0, 0)","font-size":"14pt"}},[e._v("注意: JsonWebToken 是基于 Django 所提供的 User 表进行操作的")])]),o("div",[o("br")]),o("div",[o("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[e._v("1.")]),e._v(" "),o("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[e._v("下载模块")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[e._v("pip3 install djangorestframework-jwt -i https://pypi.douban.com/simple  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 使用豆瓣的镜像")])],1)]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[e._v("2.")]),e._v(" "),o("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[e._v("全局配置")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# settings.py")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[o("br")])],1),o("div",[e._v("JWT_AUTH = {")]),o("div",[e._v("    'JWT_EXPIRATION_DELTA': datetime.timedelta(days=7),  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 过期时间，默认过期时间300秒")])],1),o("div",[e._v("    'JWT_AUTH_HEADER_PREFIX': 'JWT',  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# token前缀，默认值 JWT")])],1),o("div",[e._v("}")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[e._v("3.")]),e._v(" "),o("span",{staticStyle:{"font-size":"14pt"}},[o("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[e._v("jwt所提供的url -> 自动获取、刷新、验证 token")])])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[e._v("from rest_framework_jwt.views import (")]),o("div",[e._v("    obtain_jwt_token,")]),o("div",[e._v("    verify_jwt_token,")]),o("div",[e._v("    refresh_jwt_token")]),o("div",[e._v(")")]),o("div",[o("br")]),o("div",[e._v("urlpatterns = [")]),o("div",[e._v("    url(r'^login/', obtain_jwt_token),  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 登录验证 + 获取token")])],1),o("div",[e._v("    url(r'^api-token-refresh/', refresh_jwt_token),  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 刷新token")])],1),o("div",[e._v("    url(r'^api-token-verify/', verify_jwt_token),  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 验证token")])],1),o("div",[e._v("]")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[e._v("4.")]),e._v(" "),o("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[e._v("手动")]),o("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[e._v("获取、验证 token")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("ul",[o("li",[o("div",[e._v("其实 obtain_jwt_token 视图类都是调用 JSONWebTokenSerializer 下的 validate 方法进行验证")])]),o("li",[o("div",[e._v("其实 verify_jwt_token 视图类都是调用 VerifyJSONWebTokenSerializer 下的 validate 方法进行验证")])])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[e._v("from rest_framework.views import APIView")]),o("div",[e._v("from rest_framework.response import Response")]),o("div",[e._v("from rest_framework.authentication import BaseAuthentication")]),o("div",[e._v("from rest_framework_jwt.serializers import (")]),o("div",[e._v("    JSONWebTokenSerializer,")]),o("div",[e._v("    VerifyJSONWebTokenSerializer")]),o("div",[e._v(")")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class LoginView(APIView):")]),o("div",[e._v("    def post(self, request, *args, **kwargs):")]),o("div",[e._v("        req_data = {")]),o("div",[e._v("            'username': request.data.get('username'),")]),o("div",[e._v("            'password': request.data.get('password')")]),o("div",[e._v("        }")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 手动获取 token")])],1),o("div",[e._v("        jwt = JSONWebTokenSerializer()")]),o("div",[e._v("        user_info = jwt."),o("font",{attrs:{color:"#FA7A00"}},[e._v("validate")]),e._v("(req_data)")],1),o("div",[e._v("        return Response({'token': user_info['token']})")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class TokenAuth(BaseAuthentication):")]),o("div",[e._v("    def authenticate(self, request):")]),o("div",[e._v("        http_token = request.META.get('HTTP_TOKEN')")]),o("div",[e._v('        token = {"token": http_token}')]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 手动验证 token")])],1),o("div",[e._v("        vjt = VerifyJSONWebTokenSerializer()")]),o("div",[e._v("        valid_data = vjt."),o("font",{attrs:{color:"#FA7A00"}},[e._v("validate")]),e._v("(token)")],1),o("div",[e._v("        return valid_data['user'], valid_data['token']")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class IndexView(APIView):")]),o("div",[e._v("    authentication_classes = [TokenAuth]")]),o("div",[o("br")]),o("div",[e._v("    def get(self, request, *args, **kwargs):")]),o("div",[e._v("        return Response({")]),o("div",[e._v("            'msg': 'index_info',")]),o("div",[e._v("            'user': request.user.username,")]),o("div",[e._v("            'token': request.auth")]),o("div",[e._v("        })")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[e._v("5.")]),e._v(" "),o("span",{staticStyle:{"font-size":"14pt"}},[o("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[e._v("重写 validate 方法")])])]),o("div",[o("br")]),o("ul",[o("li",[o("div",[e._v("如果直接使用 obtain_jwt_token 视图类验证登陆，那么在登陆失败的时候会返回状态码为400的错误，如果想返回状态码为200的自定义登陆失败信息，那么就要重写 obtain_jwt_token -> JSONWebTokenSerializer -> validate 方法")])])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# login_jwt.py")])],1),o("div",[o("br")]),o("div",[e._v("from rest_framework_jwt.serializers import JSONWebTokenSerializer")]),o("div",[e._v("from rest_framework import serializers")]),o("div",[e._v("from django.contrib.auth import authenticate")]),o("div",[e._v("from django.utils.translation import ugettext as _")]),o("div",[o("br")]),o("div",[e._v("from rest_framework_jwt.settings import api_settings")]),o("div",[o("br")]),o("div",[e._v("jwt_payload_handler = api_settings.JWT_PAYLOAD_HANDLER")]),o("div",[e._v("jwt_encode_handler = api_settings.JWT_ENCODE_HANDLER")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class LoginJWT(JSONWebTokenSerializer):")]),o("div",[e._v("    def validate(self, attrs):")]),o("div",[e._v("        credentials = {")]),o("div",[e._v("            self.username_field: attrs.get(self.username_field),")]),o("div",[e._v("            'password': attrs.get('password')")]),o("div",[e._v("        }")]),o("div",[o("br")]),o("div",[e._v("        if all(credentials.values()):")]),o("div",[e._v("            user = authenticate(**credentials)")]),o("div",[o("br")]),o("div",[e._v("            if user:")]),o("div",[e._v("                if not user.is_active:")]),o("div",[e._v("                    msg = _('User account is disabled.')")]),o("div",[e._v("                    raise serializers.ValidationError(msg)")]),o("div",[o("br")]),o("div",[e._v("                payload = jwt_payload_handler(user)")]),o("div",[o("br")]),o("div",[e._v("                return {")]),o("div",[e._v("                    'token': jwt_encode_handler(payload),")]),o("div",[e._v("                    'user': user")]),o("div",[e._v("                }")]),o("div",[e._v("            else:")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 原本的写法")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("                # msg = _('Unable to log in with provided credentials.')")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("                # raise serializers.ValidationError(msg)")])],1),o("div",[o("br")]),o("div",[e._v("                raise "),o("font",{attrs:{color:"#FA7A00"}},[e._v("Exception")]),e._v("('登陆失败')  "),o("font",{attrs:{color:"#FA7A00"}},[e._v("# 不使用 serializers.ValidationError 的异常错误")])],1),o("div",[e._v("        else:")]),o("div",[e._v('            msg = _(\'Must include "{username_field}" and "password".\')')]),o("div",[e._v("            msg = msg.format(username_field=self.username_field)")]),o("div",[e._v("            raise serializers.ValidationError(msg)")])]),o("div",[o("br")]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# views.py")])],1),o("div",[o("br")]),o("div",[e._v("from rest_framework.views import APIView")]),o("div",[e._v("from rest_framework.response import Response")]),o("div",[e._v("from api.utils.login_jwt import LoginJWT")]),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class LoginView(APIView):")]),o("div",[e._v("    def post(self, request, *args, **kwargs):")]),o("div",[e._v("        try:")]),o("div",[e._v("            req_data = {")]),o("div",[e._v("                'username': request.data.get('username'),")]),o("div",[e._v("                'password': request.data.get('password')")]),o("div",[e._v("            }")]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 手动获取 token")])],1),o("div",[e._v("            jwt = LoginJWT()")]),o("div",[e._v("            user_info = jwt.validate(req_data)")]),o("div",[e._v("            return Response({'token': user_info['token']})")]),o("div",[e._v("        except "),o("font",{attrs:{color:"#FA7A00"}},[e._v("Exception")]),e._v(" as e:")],1),o("div",[e._v("            return Response({'msg': "),o("font",{attrs:{color:"#FA7A00"}},[e._v("str(e)")]),e._v("})")],1)]),o("div",[o("br")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt","white-space":"pre-wrap","font-weight":"bold"}},[e._v("6.")]),e._v(" "),o("span",{staticStyle:{"font-size":"14pt","font-weight":"bold"}},[e._v("使用 JsonWebToken 进行 token 认证的例子")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# settings.py")])],1),o("div",[o("br")]),o("div",[e._v("JWT_AUTH = {")]),o("div",[e._v("    'JWT_EXPIRATION_DELTA': datetime.timedelta(days=7),  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# 过期时间，默认过期时间300秒")])],1),o("div",[e._v("    'JWT_AUTH_HEADER_PREFIX': 'JWT',  "),o("font",{attrs:{color:"#41AD1C"}},[e._v("# token前缀，默认值 JWT")])],1),o("div",[e._v("}")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# usrls.py")])],1),o("div",[o("br")]),o("div",[e._v("from rest_framework_jwt.views import obtain_jwt_token")]),o("div",[o("br")]),o("div",[e._v("urlpatterns = [")]),o("div",[e._v("    url(r'^admin/', admin.site.urls),")]),o("div",[e._v("    url(r'^login/$', "),o("font",{attrs:{color:"#FA7A00"}},[e._v("obtain_jwt_token")]),e._v("),")],1),o("div",[e._v("    url(r'^index/$', IndexView.as_view()),")]),o("div",[e._v("]")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# auth.py")])],1),o("div",[o("br")]),o("div",[e._v("from rest_framework.authentication import BaseAuthentication")]),o("div",[e._v("from rest_framework_jwt.serializers import "),o("font",{attrs:{color:"#FA7A00"}},[e._v("VerifyJSONWebTokenSerializer")])],1),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class TokenAuth(BaseAuthentication):")]),o("div",[e._v("    def authenticate(self, request):")]),o("div",[e._v("        http_token = request.META.get('HTTP_TOKEN')")]),o("div",[e._v('        token = {"token": http_token}')]),o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# 手动验证 token")])],1),o("div",[e._v("        vjt = "),o("font",{attrs:{color:"#FA7A00"}},[e._v("VerifyJSONWebTokenSerializer()")])],1),o("div",[e._v("        valid_data = vjt."),o("font",{attrs:{color:"#FA7A00"}},[e._v("validate")]),e._v("(token)")],1),o("div",[e._v("        return valid_data['user'], valid_data['token']")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])]),o("div",{staticStyle:{"box-sizing":"border-box",padding:"8px","font-family":'Monaco, Menlo, Consolas, "Courier New", monospace',"font-size":"12px",color:"rgb(51, 51, 51)","border-radius":"4px","background-color":"rgb(251, 250, 248)",border:"1px solid rgba(0, 0, 0, 0.15)","-en-codeblock":"true"}},[o("div",[o("font",{attrs:{color:"#41AD1C"}},[e._v("# views.py")])],1),o("div",[o("font",{attrs:{color:"#41AD1C"}},[o("br")])],1),o("div",[e._v("from rest_framework.views import APIView")]),o("div",[e._v("from rest_framework.response import Response")]),o("div",[e._v("from api.utils.auth import "),o("font",{attrs:{color:"#FA7A00"}},[e._v("TokenAuth")])],1),o("div",[o("br")]),o("div",[o("br")]),o("div",[e._v("class IndexView(APIView):")]),o("div",[e._v("    authentication_classes = ["),o("font",{attrs:{color:"#FA7A00"}},[e._v("TokenAuth")]),e._v("]")],1),o("div",[o("br")]),o("div",[e._v("    def get(self, request, *args, **kwargs):")]),o("div",[e._v("        return Response({")]),o("div",[e._v("            'username': request.user.username,")]),o("div",[e._v("            'token': request.auth,")]),o("div",[e._v("            'msg': 'index_info'")]),o("div",[e._v("        })")])]),o("div",[o("span",{staticStyle:{"font-size":"14pt"}},[o("br")])])])])])}),[],!1,null,null,null);t.default=i.exports}}]);