<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>上下文管理 | Kevin-Blog</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/kevin-blog/logo.png">
    <meta name="description" content="">
    <link rel="preload" href="/kevin-blog/assets/css/0.styles.267bc68b.css" as="style"><link rel="preload" href="/kevin-blog/assets/js/app.dd46475d.js" as="script"><link rel="preload" href="/kevin-blog/assets/js/2.97d04891.js" as="script"><link rel="preload" href="/kevin-blog/assets/js/116.b3eb5cab.js" as="script"><link rel="prefetch" href="/kevin-blog/assets/js/10.2b686438.js"><link rel="prefetch" href="/kevin-blog/assets/js/100.cfc5acd5.js"><link rel="prefetch" href="/kevin-blog/assets/js/101.628bd39e.js"><link rel="prefetch" href="/kevin-blog/assets/js/102.41585307.js"><link rel="prefetch" href="/kevin-blog/assets/js/103.5d18350a.js"><link rel="prefetch" href="/kevin-blog/assets/js/104.85cd65cf.js"><link rel="prefetch" href="/kevin-blog/assets/js/105.9d303bac.js"><link rel="prefetch" href="/kevin-blog/assets/js/106.73f6a263.js"><link rel="prefetch" href="/kevin-blog/assets/js/107.9dfe114c.js"><link rel="prefetch" href="/kevin-blog/assets/js/108.315e8c63.js"><link rel="prefetch" href="/kevin-blog/assets/js/109.ef21ffa0.js"><link rel="prefetch" href="/kevin-blog/assets/js/11.2b0f6358.js"><link rel="prefetch" href="/kevin-blog/assets/js/110.dfe062a3.js"><link rel="prefetch" href="/kevin-blog/assets/js/111.08f0c3e7.js"><link rel="prefetch" href="/kevin-blog/assets/js/112.0e180f10.js"><link rel="prefetch" href="/kevin-blog/assets/js/113.295f1fca.js"><link rel="prefetch" href="/kevin-blog/assets/js/114.5645d09d.js"><link rel="prefetch" href="/kevin-blog/assets/js/115.ebe19212.js"><link rel="prefetch" href="/kevin-blog/assets/js/117.076c6372.js"><link rel="prefetch" href="/kevin-blog/assets/js/118.226fb513.js"><link rel="prefetch" href="/kevin-blog/assets/js/119.298c0302.js"><link rel="prefetch" href="/kevin-blog/assets/js/12.01390043.js"><link rel="prefetch" href="/kevin-blog/assets/js/120.943d0d71.js"><link rel="prefetch" href="/kevin-blog/assets/js/121.2d1bd8ef.js"><link rel="prefetch" href="/kevin-blog/assets/js/122.84b9dff1.js"><link rel="prefetch" href="/kevin-blog/assets/js/123.85d93d87.js"><link rel="prefetch" href="/kevin-blog/assets/js/124.4913aefd.js"><link rel="prefetch" href="/kevin-blog/assets/js/125.cf667169.js"><link rel="prefetch" href="/kevin-blog/assets/js/126.eefd3250.js"><link rel="prefetch" href="/kevin-blog/assets/js/127.f9697daf.js"><link rel="prefetch" href="/kevin-blog/assets/js/128.aff6033d.js"><link rel="prefetch" href="/kevin-blog/assets/js/129.fa7ec9a8.js"><link rel="prefetch" href="/kevin-blog/assets/js/13.e55a4126.js"><link rel="prefetch" href="/kevin-blog/assets/js/130.9d50b78d.js"><link rel="prefetch" href="/kevin-blog/assets/js/131.f384aa34.js"><link rel="prefetch" href="/kevin-blog/assets/js/132.e60091dc.js"><link rel="prefetch" href="/kevin-blog/assets/js/133.09a9de16.js"><link rel="prefetch" href="/kevin-blog/assets/js/134.a7739a99.js"><link rel="prefetch" href="/kevin-blog/assets/js/135.bea491db.js"><link rel="prefetch" href="/kevin-blog/assets/js/136.92af3a82.js"><link rel="prefetch" href="/kevin-blog/assets/js/137.dbda7b02.js"><link rel="prefetch" href="/kevin-blog/assets/js/138.9fea4ca4.js"><link rel="prefetch" href="/kevin-blog/assets/js/139.0a81aff9.js"><link rel="prefetch" href="/kevin-blog/assets/js/14.efd69f3b.js"><link rel="prefetch" href="/kevin-blog/assets/js/140.3f048218.js"><link rel="prefetch" href="/kevin-blog/assets/js/141.002d7568.js"><link rel="prefetch" href="/kevin-blog/assets/js/142.aec10062.js"><link rel="prefetch" href="/kevin-blog/assets/js/143.2e682c5b.js"><link rel="prefetch" href="/kevin-blog/assets/js/144.d05092f0.js"><link rel="prefetch" href="/kevin-blog/assets/js/145.358437b8.js"><link rel="prefetch" href="/kevin-blog/assets/js/146.af219f24.js"><link rel="prefetch" href="/kevin-blog/assets/js/147.061cb5fe.js"><link rel="prefetch" href="/kevin-blog/assets/js/148.422d1f87.js"><link rel="prefetch" href="/kevin-blog/assets/js/149.c97f27f4.js"><link rel="prefetch" href="/kevin-blog/assets/js/15.271f58eb.js"><link rel="prefetch" href="/kevin-blog/assets/js/150.177533a9.js"><link rel="prefetch" href="/kevin-blog/assets/js/151.d70f314c.js"><link rel="prefetch" href="/kevin-blog/assets/js/152.ca40e6fc.js"><link rel="prefetch" href="/kevin-blog/assets/js/153.a2bca317.js"><link rel="prefetch" href="/kevin-blog/assets/js/154.22edbf9f.js"><link rel="prefetch" href="/kevin-blog/assets/js/155.e59b2d87.js"><link rel="prefetch" href="/kevin-blog/assets/js/156.d5a38de8.js"><link rel="prefetch" href="/kevin-blog/assets/js/157.cbe5199a.js"><link rel="prefetch" href="/kevin-blog/assets/js/158.31c5b8b2.js"><link rel="prefetch" href="/kevin-blog/assets/js/159.0763ed0c.js"><link rel="prefetch" href="/kevin-blog/assets/js/16.e92cdd55.js"><link rel="prefetch" href="/kevin-blog/assets/js/160.a05ced02.js"><link rel="prefetch" href="/kevin-blog/assets/js/161.7e52ed13.js"><link rel="prefetch" href="/kevin-blog/assets/js/162.f5df7208.js"><link rel="prefetch" href="/kevin-blog/assets/js/163.78a78de8.js"><link rel="prefetch" href="/kevin-blog/assets/js/164.54fd347c.js"><link rel="prefetch" href="/kevin-blog/assets/js/165.a0347ed3.js"><link rel="prefetch" href="/kevin-blog/assets/js/166.0702e96e.js"><link rel="prefetch" href="/kevin-blog/assets/js/167.69136cd0.js"><link rel="prefetch" href="/kevin-blog/assets/js/168.d0aa7e0d.js"><link rel="prefetch" href="/kevin-blog/assets/js/169.6229f0ca.js"><link rel="prefetch" href="/kevin-blog/assets/js/17.9a006e5d.js"><link rel="prefetch" href="/kevin-blog/assets/js/170.b6571721.js"><link rel="prefetch" href="/kevin-blog/assets/js/171.600f9683.js"><link rel="prefetch" href="/kevin-blog/assets/js/172.6e1792a7.js"><link rel="prefetch" href="/kevin-blog/assets/js/173.cef126b3.js"><link rel="prefetch" href="/kevin-blog/assets/js/174.97b3e897.js"><link rel="prefetch" href="/kevin-blog/assets/js/175.fcefca30.js"><link rel="prefetch" href="/kevin-blog/assets/js/176.31862a66.js"><link rel="prefetch" href="/kevin-blog/assets/js/177.089b09c0.js"><link rel="prefetch" href="/kevin-blog/assets/js/178.a5dcd25c.js"><link rel="prefetch" href="/kevin-blog/assets/js/179.a9d685f2.js"><link rel="prefetch" href="/kevin-blog/assets/js/18.a1c24192.js"><link rel="prefetch" href="/kevin-blog/assets/js/180.4ad69266.js"><link rel="prefetch" href="/kevin-blog/assets/js/181.691d48a2.js"><link rel="prefetch" href="/kevin-blog/assets/js/182.e77aa679.js"><link rel="prefetch" href="/kevin-blog/assets/js/183.2b4341f4.js"><link rel="prefetch" href="/kevin-blog/assets/js/184.b3610e8b.js"><link rel="prefetch" href="/kevin-blog/assets/js/185.08107897.js"><link rel="prefetch" href="/kevin-blog/assets/js/186.9f5a3f65.js"><link rel="prefetch" href="/kevin-blog/assets/js/187.ac2fe2c2.js"><link rel="prefetch" href="/kevin-blog/assets/js/188.09023a78.js"><link rel="prefetch" href="/kevin-blog/assets/js/189.409b4ed0.js"><link rel="prefetch" href="/kevin-blog/assets/js/19.c733cdfe.js"><link rel="prefetch" href="/kevin-blog/assets/js/190.ca5d775c.js"><link rel="prefetch" href="/kevin-blog/assets/js/191.8052fe42.js"><link rel="prefetch" href="/kevin-blog/assets/js/192.31ebe059.js"><link rel="prefetch" href="/kevin-blog/assets/js/193.9bf32e11.js"><link rel="prefetch" href="/kevin-blog/assets/js/194.0667554a.js"><link rel="prefetch" href="/kevin-blog/assets/js/195.ea249ba4.js"><link rel="prefetch" href="/kevin-blog/assets/js/196.6278ec5a.js"><link rel="prefetch" href="/kevin-blog/assets/js/197.90f6af7b.js"><link rel="prefetch" href="/kevin-blog/assets/js/198.2e358b6a.js"><link rel="prefetch" href="/kevin-blog/assets/js/199.a0bd0085.js"><link rel="prefetch" href="/kevin-blog/assets/js/20.890583ea.js"><link rel="prefetch" href="/kevin-blog/assets/js/200.bc1e237a.js"><link rel="prefetch" href="/kevin-blog/assets/js/201.767e166e.js"><link rel="prefetch" href="/kevin-blog/assets/js/202.a52f0e94.js"><link rel="prefetch" href="/kevin-blog/assets/js/203.06f0ebab.js"><link rel="prefetch" href="/kevin-blog/assets/js/204.7ae45191.js"><link rel="prefetch" href="/kevin-blog/assets/js/205.b8412fbc.js"><link rel="prefetch" href="/kevin-blog/assets/js/206.682f9a3e.js"><link rel="prefetch" href="/kevin-blog/assets/js/207.8978346c.js"><link rel="prefetch" href="/kevin-blog/assets/js/208.35db8c05.js"><link rel="prefetch" href="/kevin-blog/assets/js/209.1eebeab0.js"><link rel="prefetch" href="/kevin-blog/assets/js/21.48328b6a.js"><link rel="prefetch" href="/kevin-blog/assets/js/210.b56db64f.js"><link rel="prefetch" href="/kevin-blog/assets/js/211.31da36f5.js"><link rel="prefetch" href="/kevin-blog/assets/js/212.2f2d2d1f.js"><link rel="prefetch" href="/kevin-blog/assets/js/213.be55b8cc.js"><link rel="prefetch" href="/kevin-blog/assets/js/214.aeffc247.js"><link rel="prefetch" href="/kevin-blog/assets/js/215.137bae15.js"><link rel="prefetch" href="/kevin-blog/assets/js/216.2692c636.js"><link rel="prefetch" href="/kevin-blog/assets/js/217.a6a9cf62.js"><link rel="prefetch" href="/kevin-blog/assets/js/218.7353ed7a.js"><link rel="prefetch" href="/kevin-blog/assets/js/219.f1fdfe8e.js"><link rel="prefetch" href="/kevin-blog/assets/js/22.5fd865e7.js"><link rel="prefetch" href="/kevin-blog/assets/js/220.e20ab2b5.js"><link rel="prefetch" href="/kevin-blog/assets/js/221.0d06c8b0.js"><link rel="prefetch" href="/kevin-blog/assets/js/222.e39491a9.js"><link rel="prefetch" href="/kevin-blog/assets/js/223.ae98df72.js"><link rel="prefetch" href="/kevin-blog/assets/js/224.4ba5d334.js"><link rel="prefetch" href="/kevin-blog/assets/js/225.913ee059.js"><link rel="prefetch" href="/kevin-blog/assets/js/226.b8d730bd.js"><link rel="prefetch" href="/kevin-blog/assets/js/227.69ee92e2.js"><link rel="prefetch" href="/kevin-blog/assets/js/228.1cf17cff.js"><link rel="prefetch" href="/kevin-blog/assets/js/229.6ce44fac.js"><link rel="prefetch" href="/kevin-blog/assets/js/23.9ef4ab20.js"><link rel="prefetch" href="/kevin-blog/assets/js/230.30c28e05.js"><link rel="prefetch" href="/kevin-blog/assets/js/231.ef327150.js"><link rel="prefetch" href="/kevin-blog/assets/js/232.6cb791d8.js"><link rel="prefetch" href="/kevin-blog/assets/js/233.473fa94b.js"><link rel="prefetch" href="/kevin-blog/assets/js/234.848de787.js"><link rel="prefetch" href="/kevin-blog/assets/js/235.f5db4ed9.js"><link rel="prefetch" href="/kevin-blog/assets/js/236.5da3f87c.js"><link rel="prefetch" href="/kevin-blog/assets/js/237.018a543d.js"><link rel="prefetch" href="/kevin-blog/assets/js/238.74d22845.js"><link rel="prefetch" href="/kevin-blog/assets/js/239.fca187a6.js"><link rel="prefetch" href="/kevin-blog/assets/js/24.3dff5faa.js"><link rel="prefetch" href="/kevin-blog/assets/js/240.0dbbfe84.js"><link rel="prefetch" href="/kevin-blog/assets/js/241.8b1ccf29.js"><link rel="prefetch" href="/kevin-blog/assets/js/242.f5216a9f.js"><link rel="prefetch" href="/kevin-blog/assets/js/243.8e5c5e34.js"><link rel="prefetch" href="/kevin-blog/assets/js/244.8f78ae9a.js"><link rel="prefetch" href="/kevin-blog/assets/js/245.e0b2e7b9.js"><link rel="prefetch" href="/kevin-blog/assets/js/246.7700207e.js"><link rel="prefetch" href="/kevin-blog/assets/js/247.c1e13b57.js"><link rel="prefetch" href="/kevin-blog/assets/js/248.63d6adf8.js"><link rel="prefetch" href="/kevin-blog/assets/js/249.500fdd00.js"><link rel="prefetch" href="/kevin-blog/assets/js/25.0ebddc27.js"><link rel="prefetch" href="/kevin-blog/assets/js/250.ebbb5c92.js"><link rel="prefetch" href="/kevin-blog/assets/js/251.4e51605e.js"><link rel="prefetch" href="/kevin-blog/assets/js/252.2534bb33.js"><link rel="prefetch" href="/kevin-blog/assets/js/253.330d0073.js"><link rel="prefetch" href="/kevin-blog/assets/js/254.da99904b.js"><link rel="prefetch" href="/kevin-blog/assets/js/255.f9a1774e.js"><link rel="prefetch" href="/kevin-blog/assets/js/256.7ee8ac66.js"><link rel="prefetch" href="/kevin-blog/assets/js/257.41594669.js"><link rel="prefetch" href="/kevin-blog/assets/js/258.9d8beffc.js"><link rel="prefetch" href="/kevin-blog/assets/js/259.1539043a.js"><link rel="prefetch" href="/kevin-blog/assets/js/26.7e91ac9d.js"><link rel="prefetch" href="/kevin-blog/assets/js/260.034695f0.js"><link rel="prefetch" href="/kevin-blog/assets/js/261.953910a0.js"><link rel="prefetch" href="/kevin-blog/assets/js/262.e2b0764f.js"><link rel="prefetch" href="/kevin-blog/assets/js/263.fe9b0b70.js"><link rel="prefetch" href="/kevin-blog/assets/js/264.489e20f7.js"><link rel="prefetch" href="/kevin-blog/assets/js/265.43596b34.js"><link rel="prefetch" href="/kevin-blog/assets/js/266.07bb7008.js"><link rel="prefetch" href="/kevin-blog/assets/js/267.5caf5b93.js"><link rel="prefetch" href="/kevin-blog/assets/js/268.fc6e09e2.js"><link rel="prefetch" href="/kevin-blog/assets/js/269.764500c0.js"><link rel="prefetch" href="/kevin-blog/assets/js/27.55c7093f.js"><link rel="prefetch" href="/kevin-blog/assets/js/270.9760648a.js"><link rel="prefetch" href="/kevin-blog/assets/js/271.019b1f9a.js"><link rel="prefetch" href="/kevin-blog/assets/js/272.bce07ec6.js"><link rel="prefetch" href="/kevin-blog/assets/js/273.038ff1e3.js"><link rel="prefetch" href="/kevin-blog/assets/js/274.2cb7fd59.js"><link rel="prefetch" href="/kevin-blog/assets/js/275.3c831af6.js"><link rel="prefetch" href="/kevin-blog/assets/js/276.8d0732f8.js"><link rel="prefetch" href="/kevin-blog/assets/js/277.5aa0c664.js"><link rel="prefetch" href="/kevin-blog/assets/js/278.a3cdd3b8.js"><link rel="prefetch" href="/kevin-blog/assets/js/279.d049a479.js"><link rel="prefetch" href="/kevin-blog/assets/js/28.da28db4a.js"><link rel="prefetch" href="/kevin-blog/assets/js/280.6b7f68c4.js"><link rel="prefetch" href="/kevin-blog/assets/js/281.eff251cb.js"><link rel="prefetch" href="/kevin-blog/assets/js/282.f0dc7866.js"><link rel="prefetch" href="/kevin-blog/assets/js/283.36ca2fb9.js"><link rel="prefetch" href="/kevin-blog/assets/js/284.470e6db4.js"><link rel="prefetch" href="/kevin-blog/assets/js/285.a9c60b36.js"><link rel="prefetch" href="/kevin-blog/assets/js/286.3eff6f51.js"><link rel="prefetch" href="/kevin-blog/assets/js/287.f406cf63.js"><link rel="prefetch" href="/kevin-blog/assets/js/288.d6bb5731.js"><link rel="prefetch" href="/kevin-blog/assets/js/289.518409f3.js"><link rel="prefetch" href="/kevin-blog/assets/js/29.37ea8137.js"><link rel="prefetch" href="/kevin-blog/assets/js/290.e4795980.js"><link rel="prefetch" href="/kevin-blog/assets/js/291.6ca97e3d.js"><link rel="prefetch" href="/kevin-blog/assets/js/292.f434852f.js"><link rel="prefetch" href="/kevin-blog/assets/js/293.256f39e1.js"><link rel="prefetch" href="/kevin-blog/assets/js/294.0e051edc.js"><link rel="prefetch" href="/kevin-blog/assets/js/295.d6a1cfbb.js"><link rel="prefetch" href="/kevin-blog/assets/js/296.9a3f4bb2.js"><link rel="prefetch" href="/kevin-blog/assets/js/297.374bbc2d.js"><link rel="prefetch" href="/kevin-blog/assets/js/298.c37b0145.js"><link rel="prefetch" href="/kevin-blog/assets/js/299.008098d2.js"><link rel="prefetch" href="/kevin-blog/assets/js/3.0c6053de.js"><link rel="prefetch" href="/kevin-blog/assets/js/30.24e20f30.js"><link rel="prefetch" href="/kevin-blog/assets/js/300.ab07139a.js"><link rel="prefetch" href="/kevin-blog/assets/js/301.69ee5ffa.js"><link rel="prefetch" href="/kevin-blog/assets/js/302.05af46d8.js"><link rel="prefetch" href="/kevin-blog/assets/js/303.cec1cf65.js"><link rel="prefetch" href="/kevin-blog/assets/js/304.7c82ba6c.js"><link rel="prefetch" href="/kevin-blog/assets/js/305.7ac25f4a.js"><link rel="prefetch" href="/kevin-blog/assets/js/306.82149841.js"><link rel="prefetch" href="/kevin-blog/assets/js/307.f56afc9c.js"><link rel="prefetch" href="/kevin-blog/assets/js/308.7c084ed0.js"><link rel="prefetch" href="/kevin-blog/assets/js/309.feb89623.js"><link rel="prefetch" href="/kevin-blog/assets/js/31.19d1e3af.js"><link rel="prefetch" href="/kevin-blog/assets/js/310.1e33889a.js"><link rel="prefetch" href="/kevin-blog/assets/js/311.416e7d20.js"><link rel="prefetch" href="/kevin-blog/assets/js/312.ee11dbec.js"><link rel="prefetch" href="/kevin-blog/assets/js/313.f58bb112.js"><link rel="prefetch" href="/kevin-blog/assets/js/314.543b2b1c.js"><link rel="prefetch" href="/kevin-blog/assets/js/315.18b9a70e.js"><link rel="prefetch" href="/kevin-blog/assets/js/316.6dfba854.js"><link rel="prefetch" href="/kevin-blog/assets/js/317.19590777.js"><link rel="prefetch" href="/kevin-blog/assets/js/318.a3ec0c19.js"><link rel="prefetch" href="/kevin-blog/assets/js/319.f990a61a.js"><link rel="prefetch" href="/kevin-blog/assets/js/32.07887ecb.js"><link rel="prefetch" href="/kevin-blog/assets/js/320.a3c5cbbf.js"><link rel="prefetch" href="/kevin-blog/assets/js/321.1f58e49c.js"><link rel="prefetch" href="/kevin-blog/assets/js/322.032ff5a2.js"><link rel="prefetch" href="/kevin-blog/assets/js/323.cdd3ba68.js"><link rel="prefetch" href="/kevin-blog/assets/js/324.5238a4e1.js"><link rel="prefetch" href="/kevin-blog/assets/js/325.df06c071.js"><link rel="prefetch" href="/kevin-blog/assets/js/33.9539a78e.js"><link rel="prefetch" href="/kevin-blog/assets/js/34.fa08dd12.js"><link rel="prefetch" href="/kevin-blog/assets/js/35.d6823664.js"><link rel="prefetch" href="/kevin-blog/assets/js/36.5e074071.js"><link rel="prefetch" href="/kevin-blog/assets/js/37.f4a65a95.js"><link rel="prefetch" href="/kevin-blog/assets/js/38.4f127420.js"><link rel="prefetch" href="/kevin-blog/assets/js/39.a5427f94.js"><link rel="prefetch" href="/kevin-blog/assets/js/4.a60d4c06.js"><link rel="prefetch" href="/kevin-blog/assets/js/40.859a530c.js"><link rel="prefetch" href="/kevin-blog/assets/js/41.b61d8247.js"><link rel="prefetch" href="/kevin-blog/assets/js/42.cd204014.js"><link rel="prefetch" href="/kevin-blog/assets/js/43.8076c8fc.js"><link rel="prefetch" href="/kevin-blog/assets/js/44.8a85cf72.js"><link rel="prefetch" href="/kevin-blog/assets/js/45.f46f354b.js"><link rel="prefetch" href="/kevin-blog/assets/js/46.5990e5be.js"><link rel="prefetch" href="/kevin-blog/assets/js/47.9381b746.js"><link rel="prefetch" href="/kevin-blog/assets/js/48.77d95473.js"><link rel="prefetch" href="/kevin-blog/assets/js/49.fc6dff0d.js"><link rel="prefetch" href="/kevin-blog/assets/js/5.6b8c7ebc.js"><link rel="prefetch" href="/kevin-blog/assets/js/50.297dac6d.js"><link rel="prefetch" href="/kevin-blog/assets/js/51.c6ed15a6.js"><link rel="prefetch" href="/kevin-blog/assets/js/52.8bb5ec6f.js"><link rel="prefetch" href="/kevin-blog/assets/js/53.32ab5818.js"><link rel="prefetch" href="/kevin-blog/assets/js/54.1fe541f9.js"><link rel="prefetch" href="/kevin-blog/assets/js/55.6084b23b.js"><link rel="prefetch" href="/kevin-blog/assets/js/56.242cd75a.js"><link rel="prefetch" href="/kevin-blog/assets/js/57.a3aa61b8.js"><link rel="prefetch" href="/kevin-blog/assets/js/58.5dc813ec.js"><link rel="prefetch" href="/kevin-blog/assets/js/59.0649b9f5.js"><link rel="prefetch" href="/kevin-blog/assets/js/6.8f60ce79.js"><link rel="prefetch" href="/kevin-blog/assets/js/60.e912e60f.js"><link rel="prefetch" href="/kevin-blog/assets/js/61.2348484b.js"><link rel="prefetch" href="/kevin-blog/assets/js/62.43b03d30.js"><link rel="prefetch" href="/kevin-blog/assets/js/63.6e56096d.js"><link rel="prefetch" href="/kevin-blog/assets/js/64.c45908b4.js"><link rel="prefetch" href="/kevin-blog/assets/js/65.aab0a20e.js"><link rel="prefetch" href="/kevin-blog/assets/js/66.2555ebea.js"><link rel="prefetch" href="/kevin-blog/assets/js/67.80828b1b.js"><link rel="prefetch" href="/kevin-blog/assets/js/68.5b1b38ff.js"><link rel="prefetch" href="/kevin-blog/assets/js/69.d735686b.js"><link rel="prefetch" href="/kevin-blog/assets/js/7.8fc0c0e7.js"><link rel="prefetch" href="/kevin-blog/assets/js/70.fd567fdf.js"><link rel="prefetch" href="/kevin-blog/assets/js/71.3dc39cbd.js"><link rel="prefetch" href="/kevin-blog/assets/js/72.6fe3454c.js"><link rel="prefetch" href="/kevin-blog/assets/js/73.80c96fab.js"><link rel="prefetch" href="/kevin-blog/assets/js/74.7b652913.js"><link rel="prefetch" href="/kevin-blog/assets/js/75.a9cc5506.js"><link rel="prefetch" href="/kevin-blog/assets/js/76.81bca567.js"><link rel="prefetch" href="/kevin-blog/assets/js/77.1851c464.js"><link rel="prefetch" href="/kevin-blog/assets/js/78.06a9be2e.js"><link rel="prefetch" href="/kevin-blog/assets/js/79.89ac9186.js"><link rel="prefetch" href="/kevin-blog/assets/js/8.d7f3575e.js"><link rel="prefetch" href="/kevin-blog/assets/js/80.76b8cfc2.js"><link rel="prefetch" href="/kevin-blog/assets/js/81.7c87b7a7.js"><link rel="prefetch" href="/kevin-blog/assets/js/82.1995f469.js"><link rel="prefetch" href="/kevin-blog/assets/js/83.dd77915d.js"><link rel="prefetch" href="/kevin-blog/assets/js/84.d167dd7d.js"><link rel="prefetch" href="/kevin-blog/assets/js/85.b858e7d4.js"><link rel="prefetch" href="/kevin-blog/assets/js/86.c4508e18.js"><link rel="prefetch" href="/kevin-blog/assets/js/87.e5015ac2.js"><link rel="prefetch" href="/kevin-blog/assets/js/88.03ea7184.js"><link rel="prefetch" href="/kevin-blog/assets/js/89.6c4aecd6.js"><link rel="prefetch" href="/kevin-blog/assets/js/9.541bf307.js"><link rel="prefetch" href="/kevin-blog/assets/js/90.e64c083e.js"><link rel="prefetch" href="/kevin-blog/assets/js/91.208ff0cf.js"><link rel="prefetch" href="/kevin-blog/assets/js/92.0247f769.js"><link rel="prefetch" href="/kevin-blog/assets/js/93.1d51e9e8.js"><link rel="prefetch" href="/kevin-blog/assets/js/94.52fd5e59.js"><link rel="prefetch" href="/kevin-blog/assets/js/95.3641a4fe.js"><link rel="prefetch" href="/kevin-blog/assets/js/96.a96da06a.js"><link rel="prefetch" href="/kevin-blog/assets/js/97.877152bf.js"><link rel="prefetch" href="/kevin-blog/assets/js/98.4fe249c2.js"><link rel="prefetch" href="/kevin-blog/assets/js/99.400d0dc4.js">
    <link rel="stylesheet" href="/kevin-blog/assets/css/0.styles.267bc68b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kevin-blog/" class="home-link router-link-active"><!----> <span class="site-name">Kevin-Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web" class="dropdown-title"><span class="title">Web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kevin-blog/ES6/Map 数据结构.html" class="nav-link">
  ES6
</a></li></ul></div></div><div class="nav-item"><a href="/kevin-blog/Python/DBUtils 数据库连接池模块.html" class="nav-link">
  Python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Django" class="dropdown-title"><span class="title">Django</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kevin-blog/Django/Ajax.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/kevin-blog/Django ORM/ORM-ContentType.html" class="nav-link">
  ORM
</a></li><li class="dropdown-item"><!----> <a href="/kevin-blog/Django Rest-Framework/JWT - JSON Web Tokens.html" class="nav-link">
  Rest-Framework
</a></li></ul></div></div><div class="nav-item"><a href="/kevin-blog/Flask/Flask 文件上传.html" class="nav-link">
  Flask
</a></div><div class="nav-item"><a href="/kevin-blog/Git GitHub/Git.html" class="nav-link">
  Git GitHub
</a></div><div class="nav-item"><a href="/kevin-blog/Linux/CentOS 下载和安装.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/kevin-blog/MySQL/distinct 去重.html" class="nav-link">
  MySQL
</a></div><div class="nav-item"><a href="/kevin-blog/爬虫/Anaconda环境.html" class="nav-link">
  爬虫
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web" class="dropdown-title"><span class="title">Web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kevin-blog/ES6/Map 数据结构.html" class="nav-link">
  ES6
</a></li></ul></div></div><div class="nav-item"><a href="/kevin-blog/Python/DBUtils 数据库连接池模块.html" class="nav-link">
  Python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Django" class="dropdown-title"><span class="title">Django</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kevin-blog/Django/Ajax.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/kevin-blog/Django ORM/ORM-ContentType.html" class="nav-link">
  ORM
</a></li><li class="dropdown-item"><!----> <a href="/kevin-blog/Django Rest-Framework/JWT - JSON Web Tokens.html" class="nav-link">
  Rest-Framework
</a></li></ul></div></div><div class="nav-item"><a href="/kevin-blog/Flask/Flask 文件上传.html" class="nav-link">
  Flask
</a></div><div class="nav-item"><a href="/kevin-blog/Git GitHub/Git.html" class="nav-link">
  Git GitHub
</a></div><div class="nav-item"><a href="/kevin-blog/Linux/CentOS 下载和安装.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/kevin-blog/MySQL/distinct 去重.html" class="nav-link">
  MySQL
</a></div><div class="nav-item"><a href="/kevin-blog/爬虫/Anaconda环境.html" class="nav-link">
  爬虫
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Flask</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kevin-blog/Flask/Flask 文件上传.html" class="sidebar-link">Flask 文件上传</a></li><li><a href="/kevin-blog/Flask/Flask 的启动流程.html" class="sidebar-link">Flask 的启动流程</a></li><li><a href="/kevin-blog/Flask/Flask 类的常用配置.html" class="sidebar-link">Flask 类的常用配置</a></li><li><a href="/kevin-blog/Flask/HTML模板.html" class="sidebar-link">HTML模板</a></li><li><a href="/kevin-blog/Flask/Session.html" class="sidebar-link">Session</a></li><li><a href="/kevin-blog/Flask/WTForms 组件.html" class="sidebar-link">WTForms 组件</a></li><li><a href="/kevin-blog/Flask/cookie.html" class="sidebar-link">cookie</a></li><li><a href="/kevin-blog/Flask/current_app.html" class="sidebar-link">current_app</a></li><li><a href="/kevin-blog/Flask/flash 闪现（消息机制）.html" class="sidebar-link">flash 闪现（消息机制）</a></li><li><a href="/kevin-blog/Flask/flask 最终的目录结构.html" class="sidebar-link">flask 最终的目录结构</a></li><li><a href="/kevin-blog/Flask/flask-migrate 模块.html" class="sidebar-link">flask-migrate 模块</a></li><li><a href="/kevin-blog/Flask/flask-script 模块.html" class="sidebar-link">flask-script 模块</a></li><li><a href="/kevin-blog/Flask/flask-sqlalchemy 模块.html" class="sidebar-link">flask-sqlalchemy 模块</a></li><li><a href="/kevin-blog/Flask/g.html" class="sidebar-link">g</a></li><li><a href="/kevin-blog/Flask/werkzeug 模块的使用.html" class="sidebar-link">werkzeug 模块的使用</a></li><li><a href="/kevin-blog/Flask/上下文管理.html" class="active sidebar-link">上下文管理</a></li><li><a href="/kevin-blog/Flask/中间件.html" class="sidebar-link">中间件</a></li><li><a href="/kevin-blog/Flask/介绍与安装.html" class="sidebar-link">介绍与安装</a></li><li><a href="/kevin-blog/Flask/使用Flask的注意事项.html" class="sidebar-link">使用Flask的注意事项</a></li><li><a href="/kevin-blog/Flask/特殊装饰器.html" class="sidebar-link">特殊装饰器</a></li><li><a href="/kevin-blog/Flask/蓝图.html" class="sidebar-link">蓝图</a></li><li><a href="/kevin-blog/Flask/视图.html" class="sidebar-link">视图</a></li><li><a href="/kevin-blog/Flask/路由.html" class="sidebar-link">路由</a></li><li><a href="/kevin-blog/Flask/配置文件的使用.html" class="sidebar-link">配置文件的使用</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div><span><div><div><div><div><div><div><h2 style="margin:10px 0px 12px;padding:0px 0px 0px 15px;font-size:21px;background-color:#3eaf7c;border-radius:3px;text-align:center;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;"><span style="font-size:21px;background-color:#3eaf7c;border-radius:3px;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;color:white;font-family:&quot;Helvetica Neue&quot;, Helvetica, Verdana, Arial, sans-serif;font-variant-caps:normal;font-variant-ligatures:normal;font-weight:bold;line-height:1.5;">threading.local</span></h2><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">1.</span> <span style="font-size:14pt;font-weight:bold;">引子</span></div><div><br></div><ul><li><div>假如，开了十个线程并且做同样的一件事，他们需要带着自己的数据进来，完成事情后带着自己的数据出去。如果是并发，同时进来，他们的数据就会混乱</div></li></ul><div><br></div><ul><li><div>一般情况，我们加锁就可以了，一个人先进来，先加锁，另一个人过来看到加锁了，就在外面等，等里面的人出来，自己进去加锁，这样就不会出现数据混乱的问题</div></li></ul><div><br></div><ul><li><div>另一种解决方法就是使用 threading.local() 来解决</div></li></ul><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">2.</span> <span style="font-size:14pt;font-weight:bold;">介绍</span></div></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div><span style="font-size:12pt;color:rgb(227, 0, 0);">threading.local 会根据线程id为每一个线程创建一块内存空间（即：每一个线程都有一块独立的内存空间进行数据的存储）</span></div></li></ul><div><br></div><ul><li><div><span style="font-size:12pt;"><span style="font-size:12pt;color:rgb(227, 0, 0);">threading.local 只能为线程开辟空间</span></span></div></li></ul><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">3.</span> <span style="font-size:14pt;font-weight:bold;">作用</span></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div><span style="font-size:12pt;color:rgb(227, 0, 0);">为每一个线程创建一个独立的内存空间，使得线程对自己的内存中的数据进行操作，实现了线程与线程之间的数据隔离</span></div></li></ul><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">4</span><span style="white-space:pre-wrap;font-size:14pt;font-weight:bold;">.</span><span style="font-size:14pt;font-weight:bold;"> 锁 和 threading.local 的区别</span></div><div><font style="font-size:12pt;"><br></font></div><ul><li><div><span style="font-size:12pt;">锁: 是为了让多个线程修改同一份数据</span></div></li></ul><div><br></div><ul><li><div><span style="font-size:12pt;">threading.local: 为每一个线程创建一块内存空间保存各自的数据</span></div></li></ul><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">5.</span> <span style="font-size:14pt;font-weight:bold;">引子的例子</span></div><div><span style="font-size:14pt;"><br></span></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import threading</div><div><br></div><div>v = 0</div><div><br></div><div><br></div><div>def task(i):</div><div>    global v</div><div>    v = i</div><div>    print(v)  <font color="#41AD1C"># 打印结果: 0, 1, 2, 3, 4, 5, 6, 7, 8, 9</font></div><div><br></div><div><br></div><div>for i in range(10):</div><div>    t = threading.Thread(target=task, args=[i])  <font style="color:rgb(65, 173, 28);"># 开启10个线程执行task函数</font></div><div>    t.start()</div></div><div><br></div><ul><li><div>此时上面的打印结果看不出任何的问题是因为执行的速度太快了，如果执行速度太快，那么它们取到的值有可能是不一样的</div></li></ul><div><br></div><ul><li><div>只要在打印结果之前执行以下 time.sleep 就可以看到效果了 </div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import threading</div><div>import time</div><div><br></div><div>v = 0</div><div><br></div><div><br></div><div>def task(i):</div><div>    global v</div><div>    v = i</div><div>    time.sleep(2)</div><div>    print(v)  <font color="#41AD1C"># 打印结果: 9, 9, 9, 9, 9, 9, 9, 9, 9, 9</font></div><div><br></div><div><br></div><div>for i in range(10):</div><div>    t = threading.Thread(target=task, args=[i]) <font color="#41AD1C"> # 开启10个线程执行task函数</font></div><div>    t.start()</div></div><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">6.</span> <span style="font-size:14pt;font-weight:bold;">threading.local 的使用</span></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div><span style="font-size:12pt;">使用 threading.local 解决引子的问题</span></div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import threading</div><div>import time</div><div>from threading import local</div><div><br></div><div><font color="#FA7A00">local_obj = local()</font> <font color="#41AD1C"> # 实例化local对象</font></div><div><br></div><div><br></div><div>def task(i):</div><div><font color="#FA7A00">local_obj.abc = i </font> <font color="#41AD1C"># 将值赋值给local对象上的自定义属性上</font></div><div>    time.sleep(2)</div><div>    print(local_obj.abc)  <font style="color:rgb(65, 173, 28);"># 打印结果: 0, 3, 2, 4, 5, 1, 9, 6, 8, 7 -&gt; 没有按照顺序打印是因为线程的调用顺序是由CPU来决定的</font></div><div><br></div><div><br></div><div>for i in range(10):</div><div>    t = threading.Thread(target=task, args=[i])  <font color="#41AD1C"># 开启10个线程执行task函数</font></div><div>    t.start()</div></div><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">7.</span> <span style="font-size:14pt;font-weight:bold;">自定义 </span><span style="font-size:14pt;font-weight:bold;">threading.local 的功能</span></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div>函数写法</div></li></ul><div><br></div><ul><ul><li><div>思路: 将 线程唯一标识 作为key，所要保存的值作为 value，存储在字典中</div></li></ul></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import threading  <font color="#41AD1C"># 线程模块</font></div><div>import time</div><div><br></div><div>DIC = {}</div><div><br></div><div><font color="#41AD1C">&quot;&quot;&quot;</font></div><div><font color="#41AD1C">DIC = {</font></div><div><font color="#41AD1C">    5104: {'xxx': 2},</font></div><div><font color="#41AD1C">    14432: {'xxx': 4},</font></div><div><font color="#41AD1C">    13940: {'xxx': 7}</font></div><div><font color="#41AD1C">    ……</font></div><div><font color="#41AD1C">}</font></div><div><font color="#41AD1C">&quot;&quot;&quot;</font></div><div><br></div><div><br></div><div>def task(i):</div><div>    get_ident = threading.get_ident()  <font color="#41AD1C"># 获取线程的唯一标识</font></div><div>    if get_ident in DIC:</div><div>        DIC[get_ident]['xxx'] = i</div><div>    else:</div><div>        DIC[get_ident] = {'xxx': i}</div><div>    time.sleep(2)</div><div>    print(DIC[get_ident]['xxx'])  <font color="#41AD1C"># 打印结果: 0, 3, 2, 4, 5, 1, 9, 6, 8, 7 -&gt; 没有按照顺序打印是因为线程的调用顺序是由CPU来决定的</font></div><div><br></div><div><br></div><div>for i in range(10):</div><div>    t = threading.Thread(target=task, args=[i])</div><div>    t.start()</div></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div>类写法</div></li></ul><div><br></div><ul><ul><li><div><span style="font-size:12pt;">自定义一个类似于 threading.local 的类，且在这基础上添加了支持协程的功能</span></div></li></ul></ul><div><br></div><ul><ul><li><div>思路: 将 线程唯一标识 或 协程唯一标识 作为key，所要保存的值作为 value，存储在字典中</div></li></ul></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import threading  <font color="#41AD1C"># 线程模块</font></div><div>import time</div><div><br></div><div><br></div><div><font color="#41AD1C"># 创建一个类似于 threading.local 的类</font></div><div>class Local(object):</div><div>    DIC = {}</div><div><font color="#41AD1C">&quot;&quot;&quot;</font></div><div><font color="#41AD1C">    DIC = {</font></div><div><font color="#41AD1C">        5104: {'xxx': 2},</font></div><div><font color="#41AD1C">        14432: {'xxx': 4},</font></div><div><font color="#41AD1C">        13940: {'xxx': 7}</font></div><div><font color="#41AD1C">        ……</font></div><div><font color="#41AD1C">    }</font></div><div><font color="#41AD1C">    &quot;&quot;&quot;</font></div><div><br></div><div><font color="#41AD1C"># 获取线程或协程的唯一标识</font></div><div>    def get_ident(self):</div><div><font color="#41AD1C"># 如果有协程就优先使用协程，如果没有就使用线程</font></div><div>        try:</div><div>            import greenlet  <font color="#41AD1C"># 因为 greenlet 是第三方模块</font></div><div>            get_ident = greenlet.getcurrent  <font color="#41AD1C"># 获取协程的唯一标识（其实是一个函数）</font></div><div>        except Exception as e:</div><div>            get_ident = threading.get_ident()  <font color="#41AD1C"># 获取线程的唯一标识</font></div><div>        return get_ident</div><div><br></div><div><font color="#41AD1C"> # 获取值</font></div><div>    def __getattr__(self, item):</div><div>        ident = self.get_ident()</div><div>        if ident in self.DIC:</div><div>            return self.DIC[ident].get(item)</div><div><br></div><div><font color="#41AD1C"> # 设置值</font></div><div>    def __setattr__(self, key, value):</div><div>        ident = self.get_ident()</div><div>        if ident in self.DIC:</div><div>            self.DIC[ident][key] = value</div><div>        else:</div><div>            self.DIC[ident] = {key: value}</div><div><br></div><div><br></div><div>local_obj = Local()  <font color="#41AD1C"># 实例化local对象</font></div><div><br></div><div><br></div><div>def task(i):</div><div>    local_obj.abc = i</div><div>    time.sleep(2)</div><div>    print(local_obj.abc)  <font color="#41AD1C"># 打印结果: 0, 3, 2, 4, 5, 1, 9, 6, 8, 7 -&gt; 没有按照顺序打印是因为线程的调用顺序是由CPU来决定的</font></div><div><br></div><div><br></div><div>for i in range(10):</div><div>    t = threading.Thread(target=task, args=[i])</div><div>    t.start()</div></div><div><br></div><h2 style="margin:10px 0px 12px;padding:0px 0px 0px 15px;font-size:21px;background-color:#3eaf7c;border-radius:3px;text-align:center;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;"><span style="font-size:21px;background-color:#3eaf7c;border-radius:3px;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;color:white;font-family:&quot;Helvetica Neue&quot;, Helvetica, Verdana, Arial, sans-serif;font-variant-caps:normal;font-variant-ligatures:normal;font-weight:bold;line-height:1.5;">Flask的上下文管理机制的介绍</span></h2></div><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">1.</span> <span style="font-size:14pt;font-weight:bold;">介绍</span></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div><span style="font-size:12pt;">Flask的上下文管理机制类似于 threading.local</span></div></li></ul><div><br></div><ul><li><div><span style="font-size:12pt;">Flask的上下文管理机制的写法类似于 threading.local 章节中的 自定义 threading.local 的功能 -&gt; 类写法</span></div></li></ul><div><br></div><ul><li><div><span style="font-size:12pt;color:rgb(227, 0, 0);">根据线程或协程的唯一标识为每一个线程或协程创建一块内存空间（即：每一个线程或协程都有一块独立的内存空间进行数据的存储）</span></div></li></ul><div><br></div><ul><li><div><span style="font-size:12pt;">Flask的上下文管理机制可以</span><span style="font-size:12pt;">为线程或协程开辟空间</span></div></li></ul><div><br></div><ul><li><div>通俗理解上下文管理机制: 每个线程或协程都有自己的内存空间保存自身对应的数据</div></li></ul><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">2.</span> <span style="font-size:14pt;font-weight:bold;">作用</span></div><div><br></div><ul><li><div><span style="font-size:12pt;color:rgb(227, 0, 0);">为每一个线程或协程创建一个独立的内存空间，使得线程或协程对自己的内存中的数据进行操作，实现了（线程/协程</span><span style="font-size:12pt;color:rgb(227, 0, 0);">）</span><span style="font-size:12pt;color:rgb(227, 0, 0);">与（线程/协程</span><span style="font-size:12pt;color:rgb(227, 0, 0);">）</span><span style="font-size:12pt;color:rgb(227, 0, 0);">之间的数据隔离</span></div></li></ul><div><br></div><h2 style="margin:10px 0px 12px;padding:0px 0px 0px 15px;font-size:21px;background-color:#3eaf7c;border-radius:3px;text-align:center;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;"><span style="font-size:21px;background-color:#3eaf7c;border-radius:3px;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;color:white;font-family:&quot;Helvetica Neue&quot;, Helvetica, Verdana, Arial, sans-serif;font-variant-caps:normal;font-variant-ligatures:normal;font-weight:bold;line-height:1.5;">Flask的请求上下文管理机制</span></h2><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">1.</span> <span style="font-size:14pt;font-weight:bold;">Flask </span><span style="font-size:14pt;font-weight:bold;">请求</span><span style="font-size:14pt;font-weight:bold;">上下文管理机制的说明</span></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div>请求上下文包含了: request、session</div></li></ul><div><br></div><ul><li><div><span style="color:rgb(227, 0, 0);font-weight:bold;">注意: 请求上下文和app上下文所使用的 Local LocalStack LocalProxy 都是同一个类（即: 请求上下文 和 app上下文所生成的数据都会保存在同一个 __storage__ 字典内）</span></div></li></ul><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">2.</span> <span style="font-size:14pt;font-weight:bold;">Flask 请求上下文管理机制重要源码分析</span></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div>类和方法的说明:</div></li></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">Local 类</span>: 为每个线程或协程开辟各自的空间储存数据</div></li><ul><li><div>通俗理解: Local 类创建了一个名为 __storage__ 字典存储着每个线程或协程的数据</div></li></ul></ul></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">LocalStack 类</span>: 帮助我们对 __storage__ 字典下的 stack 列表维护成一个栈（即: 后进先出）</div></li><ul><li><div>通俗理解: 帮助我们对 __storage__ 字典下的 stack 列表进行添加和删除操作</div></li></ul></ul></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">RequestContext 类</span>: 存储着request请求信息和session等其他相关方法的类</div></li><ul><li><div>通俗理解: 实例化一个 RequestContext 类得到一个 ctx 对象，且ctx对象下有request请求信息和session等其他相关方法，然后将该ctx对象保存在 __storage__ 字典下指定线程或协程下的 stack 列表里</div></li></ul></ul></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">LocalProxy 类</span>: 对 ctx 对象（即: request_context 对象）下的 request session 进行操作（即: 增删改查）</div></li><ul><li><div>通俗理解: 调用在 _lookup_req_object 函数的基础上所创建的偏函数获取到 ctx 对象，然后对 ctx 对象（即: request_context 对象）下的 request session 进行操作（即: 增删改查）</div></li></ul></ul></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">_lookup_req_object 函数</span>: 调用 LocalStack 下的 top 方法获取 __storage__ 下的 ctx 对象（即：request_context对象）中指定的属性（如: request、session）</div></li><ul><li><div>通俗理解: 通过 _lookup_req_object 函数可以获取到保存在 __storage__ 字典下指定线程或协程下的 stack 列表里 ctx 对象中的指定属性</div></li></ul></ul></ul><div><br></div><ul><li><div>所存储的数据结构</div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>__storage__ = {</div><div>    '线程或协程的唯一标识': {'stack': [ctx, xxx, xxx]},</div><div>    '线程或协程的唯一标识': {'stack': [ctx, xxx, xxx]},</div><div>    '线程或协程的唯一标识': {'stack': [ctx, xxx, xxx]},</div><div><font color="#41AD1C">……</font></div><div>}</div></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div>查看重要源码</div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>from flask import globals</div></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div>重要的源代码</div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font color="#41AD1C"># f.py</font></div><div><br></div><div>import functools</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 如果有协程就使用协程，如果没有则使用线程</span></div><div>try:</div><div>    from greenlet import getcurrent as get_ident</div><div>except ImportError:</div><div>    try:</div><div>        from thread import get_ident</div><div>    except ImportError:</div><div>        from _thread import get_ident</div><div><br></div><div><br></div><div><span style="color:rgb(227, 0, 0);"># 为每个线程或协程开辟各自的空间储存数据</span></div><div>class <span style="color:rgb(250, 122, 0);">Local</span>(object):</div><div>    __slots__ = (&quot;__storage__&quot;, &quot;__ident_func__&quot;)  <span style="color:rgb(65, 173, 28);"># 设置对象允许访问的变量或方法</span></div><div><br></div><div>    def __init__(self):</div><div><span style="color:rgb(65, 173, 28);"> # 调用 object.__setattr__ 方法，先将 __storage__ 和 __ident_func__ 的属性值添加到 Local 类中，然后 __setattr__ 或 __delattr__ 就可以进行调用</span></div><div>        object.__setattr__(self, &quot;__storage__&quot;, {})  <span style="color:rgb(65, 173, 28);"># __storage__ 用于存储各个线程或协程的数据的字典</span></div><div><span style="color:rgb(65, 173, 28);"> &quot;&quot;&quot;</span></div><div><span style="color:rgb(65, 173, 28);">            __storage__ 初始化的数据结构</span></div><div><span style="color:rgb(65, 173, 28);">            __storage__ = {}</span></div><div><span style="color:rgb(65, 173, 28);"></span></div><div><span style="color:rgb(65, 173, 28);">            __storage__ 添加数据后的数据结构</span></div><div><span style="color:rgb(65, 173, 28);">            __storage__ = {</span></div><div><span style="color:rgb(65, 173, 28);">                '线程或协程的唯一标识': {key: value, ……},</span></div><div><span style="color:rgb(65, 173, 28);">                '线程或协程的唯一标识': {key: value, ……},</span></div><div><span style="color:rgb(65, 173, 28);">                '线程或协程的唯一标识': {key: value, ……},</span></div><div><span style="color:rgb(65, 173, 28);">                ……</span></div><div><span style="color:rgb(65, 173, 28);">            }</span></div><div><span style="color:rgb(65, 173, 28);">        &quot;&quot;&quot;</span></div><div>        object.__setattr__(self, &quot;__ident_func__&quot;, get_ident)  <span style="color:rgb(65, 173, 28);"># __ident_func__ -&gt; 获取线程或协程的唯一标记的方法</span></div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 获取 __storage__ 中的值</span></div><div>    def __getattr__(self, name):</div><div>        try:</div><div>            return self.__storage__[self.__ident_func__()][name]</div><div>        except KeyError:</div><div>            raise AttributeError(name)</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 添加或修改 __storage__ 中的值</span></div><div>    def __setattr__(self, name, value):</div><div>        ident = self.__ident_func__()  <span style="color:rgb(65, 173, 28);"># 获取协程或线程的唯一标识</span></div><div>        storage = self.__storage__  <span style="color:rgb(65, 173, 28);"># 获取用于存储各个线程或协程的数据的字典</span></div><div>        try:</div><div>            storage[ident][name] = value</div><div>        except KeyError:</div><div>            storage[ident] = {name: value}</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 删除 __storage__ 中的值</span></div><div>    def __delattr__(self, name):</div><div>        try:</div><div>            del self.__storage__[self.__ident_func__()][name]</div><div>        except KeyError:</div><div>            raise AttributeError(name)</div><div><br></div><div><br></div><div><span style="color:rgb(227, 0, 0);"># 帮助我们对 __storage__ 字典下的 stack 列表维护成一个栈（即: 后进先出） -&gt; 通俗理解: 帮助我们对 __storage__ 字典下的 stack 列表进行添加和删除操作</span></div><div>class <span style="color:rgb(250, 122, 0);">LocalStack</span>(object):</div><div>    def __init__(self):</div><div>        self._local = Local()  <span style="color:rgb(65, 173, 28);"># 实例化local对象</span></div><div><br></div><div><span style="color:rgb(65, 173, 28);">    &quot;&quot;&quot;</span></div><div><span style="color:rgb(65, 173, 28);">        调用该类对 __storage__ 操作后的数据结构</span></div><div><span style="color:rgb(65, 173, 28);">        __storage__ = {</span></div><div><span style="color:rgb(65, 173, 28);">            '线程或协程的唯一标识': {'stack': [xxx, xxx, xxx]},</span></div><div><span style="color:rgb(65, 173, 28);">            '线程或协程的唯一标识': {'stack': [xxx, xxx, xxx]},</span></div><div><span style="color:rgb(65, 173, 28);">            '线程或协程的唯一标识': {'stack': [xxx, xxx, xxx]},</span></div><div><span style="color:rgb(65, 173, 28);">            ……</span></div><div><span style="color:rgb(65, 173, 28);">        }</span></div><div><span style="color:rgb(65, 173, 28);">    &quot;&quot;&quot;</span></div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 往 __storage__ 中的 stack 列表添加值</span></div><div>    def push(self, value):</div><div>        rv = getattr(self._local, &quot;stack&quot;, None)  <span style="color:rgb(65, 173, 28);"># 等同于 self._local.stack -&gt; 执行 Local 类中的 __getattr__ 方法</span></div><div>        if rv is None:</div><div>            self._local.stack = rv = []  <span style="color:rgb(65, 173, 28);"># 执行 Local 类中的 __setattr__ 方法</span></div><div>        rv.append(value)</div><div>        return rv</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 删除 __storage__ 中的 stack 列表的值，如果 stack 列表只有一个则不进行删除，当请求结束的时候就会调用该方法删除当前线程中的指定 ctx 对象</span></div><div>    def pop(self):</div><div>        stack = getattr(self._local, &quot;stack&quot;, None)  <span style="color:rgb(65, 173, 28);"># 等同于 self._local.stack -&gt; 执行 Local 类中的 __getattr__ 方法</span></div><div>        if stack is None:</div><div>            return None</div><div>        elif len(stack) == 1:</div><div><span style="color:rgb(65, 173, 28);"># release_local(self._local)</span></div><div>            return stack[-1]</div><div>        else:</div><div>            return stack.pop()</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 获取 __storage__ 中的 stack 列表的值</span></div><div>    @property</div><div>    def top(self):</div><div>        try:</div><div>            return self._local.stack[-1]</div><div>        except (AttributeError, IndexError):</div><div>            return None</div><div><br></div><div><br></div><div><span style="color:rgb(227, 0, 0);"># 代理</span> <font color="#E30000">-&gt; 对 ctx/app_ctx 对象（即: request_context/app_context 对象）下的 request session g app 进行操作（即: 增删改查）</font></div><div>class <span style="color:rgb(250, 122, 0);">LocalProxy</span>(object):</div><div>    __slots__ = (&quot;__local&quot;, &quot;__dict__&quot;, &quot;__name__&quot;, &quot;__wrapped__&quot;)</div><div><br></div><div>    def __init__(self, local, name=None):</div><div><span style="color:rgb(65, 173, 28);">&quot;&quot;&quot;</span></div><div><span style="color:rgb(65, 173, 28);">        :param local:  偏函数</span></div><div><span style="color:rgb(65, 173, 28);">        :param name:  request、session、g、None</span></div><div><span style="color:rgb(65, 173, 28);">        &quot;&quot;&quot;</span></div><div><br></div><div><span style="color:rgb(65, 173, 28);">        &quot;&quot;&quot;</span></div><div><span style="color:rgb(65, 173, 28);">            object.__setattr__(self, &quot;_LocalProxy__local&quot;, local) 的解释：</span></div><div><span style="color:rgb(65, 173, 28);">                1. 将 local 赋值给 _LocalProxy__local 属性，该属性可以通过 self.__local 进行访问</span></div><div><span style="color:rgb(65, 173, 28);">                2. _LocalProxy__local属性名 等于 __local 属性名</span></div><div><span style="color:rgb(65, 173, 28);">                3. 因为解释器会将 __local 替换为 _classname__local属性名 为确保名称不会与另一个类中的类似名称重叠的方式</span></div><div><span style="color:rgb(65, 173, 28);">        &quot;&quot;&quot;</span></div><div>        object.__setattr__(self, &quot;_LocalProxy__local&quot;, local)  <span style="color:rgb(65, 173, 28);"># 将 local 赋值给 _LocalProxy__local 属性，该属性可以通过 self.__local 进行访问</span></div><div>        object.__setattr__(self, &quot;__name__&quot;, name)  <span style="color:rgb(65, 173, 28);"># 将 name 赋值给 __name__ 属性</span></div><div>        if callable(local) and not hasattr(local, &quot;__release_local__&quot;):</div><div>            object.__setattr__(self, &quot;__wrapped__&quot;, local)</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 调用偏函数获取 ctx 对象（即: request_context 对象）</span></div><div>    def _get_current_object(self):</div><div>        if not hasattr(self.__local, &quot;__release_local__&quot;):</div><div>            return self.__local()  <span style="color:rgb(65, 173, 28);"># 调用偏函数获取 ctx 对象（即: request_context 对象）</span></div><div>        try:</div><div>            return getattr(self.__local, self.__name__)</div><div>        except AttributeError:</div><div>            raise RuntimeError(&quot;no object bound to %s&quot; % self.__name__)</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 当 LocalProxy 所实例化的对象执行了 对象.属性名 的时候就会执行该方法</span></div><div>    def __getattr__(self, name):</div><div>        if name == &quot;__members__&quot;:</div><div>            return dir(self._get_current_object())</div><div>        return getattr(self._get_current_object(), name)  <span style="color:rgb(65, 173, 28);"># 调用偏函数获取 ctx 对象（即: request_context 对象），然后使用反射获取 ctx 对象下的对应 request、session、g</span></div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 当 LocalProxy 所实例化的对象执行了 对象.属性名=xxx 的时候就会执行该方法</span></div><div>    __setattr__ = lambda x, n, v: setattr(x._get_current_object(), n, v)</div><div><span style="color:rgb(65, 173, 28);"># 当 LocalProxy 所实例化的对象执行了 del 对象.属性名 的时候就会执行该方法</span></div><div>    __delattr__ = lambda x, n: delattr(x._get_current_object(), n)</div><div><span style="color:rgb(65, 173, 28);"># 当 LocalProxy 所实例化的对象执行了 print/str(对象.属性名) 的时候就会执行该方法</span></div><div>    __str__ = lambda x: str(x._get_current_object())</div><div><br></div><div><br></div><div><span style="color:rgb(65, 173, 28);"># request 类</span></div><div>class Request(object):</div><div>    def __init__(self):</div><div>        self.method = 'GET'</div><div>        self.form = 123</div><div><br></div><div><br></div><div><span style="color:rgb(65, 173, 28);"># session 类</span></div><div>class Session(object):</div><div>    def __init__(self):</div><div>        self.name = 'Kevin'</div><div>        self.age = 18</div><div><br></div><div><br></div><div><span style="color:rgb(227, 0, 0);"># 一个拥有request和session信息的类</span></div><div>class <span style="color:rgb(250, 122, 0);">RequestContext</span>(object):</div><div>    def __init__(self):</div><div>        self.request = Request()</div><div>        self.session = Session()</div><div><br></div><div><br></div><div><span style="color:rgb(250, 122, 0);">_request_ctx_stack = LocalStack()  </span><span style="color:rgb(65, 173, 28);"># 实例化 LocalStack 得到 _request_ctx_stack 对象</span></div><div><span style="color:rgb(250, 122, 0);">request_context = RequestContext()  </span><span style="color:rgb(65, 173, 28);"># 实例化一个 request_context 对象，里面拥有 request 和 session 等属性</span></div><div><span style="color:rgb(250, 122, 0);">_request_ctx_stack.push(request_context)  </span><span style="color:rgb(65, 173, 28);"># 将 request_context 对象，添加到 __storage__ 中的 stack 列表中</span></div><div><br></div><div><br></div><div><span style="color:rgb(227, 0, 0);"># 调用 LocalStack 下的 top 方法获取 __storage__ 下的 request_context</span> <font color="#E30000">对象，然后根据传入的属性名通过反射获取 request_context 对象下对应的属性值</font></div><div>def <span style="color:rgb(250, 122, 0);">_lookup_req_object</span>(name):</div><div>    ctx = _request_ctx_stack.top  <span style="color:rgb(65, 173, 28);"># 调用 LocalStack 下的 top 方法获取 __storage__</span> <font color="#41AD1C">下的 ctx 对象（即：request_context 对象）</font></div><div>    return getattr(ctx, name) <span style="color:rgb(65, 173, 28);"> # 等同于 ctx.request 或者 ctx.session</span></div><div><br></div><div><br></div><div><span style="color:rgb(255, 0, 0);"># 通过 LocalProxy 对 ctx 对象（即: request_context 对象）下的 request session 进行操作（即: 增删改查）</span></div><div><span style="color:rgb(250, 122, 0);">request = LocalProxy(functools.partial(_lookup_req_object, 'request'))</span></div><div><span style="color:rgb(250, 122, 0);">session = LocalProxy(functools.partial(_lookup_req_object, 'session'))</span></div></div><div><br></div><ul><li><div>获取 request 或 session 的方式一</div></li></ul><div><br></div><ul><ul><li><div>在视图函数中也可以通过 flask.globals._request_ctx_stack 中的 _request_ctx_stack 进行获取</div></li></ul></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font color="#41AD1C"># v.py</font></div><div><br></div><div>from f import _request_ctx_stack</div><div><br></div><div>request = _request_ctx_stack.top.request</div><div>print(request.method)  <font color="#41AD1C"># GET</font></div><div><br></div><div>session = _request_ctx_stack.top.session</div><div>print(session.name)  <font color="#41AD1C"># Kevin</font></div></div><div><br></div><ul><li><div>获取 request 或 session 的方式二</div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font color="#41AD1C"># v.py</font></div><div><br></div><div>from f import request, session</div><div><br></div><div>print(request.method)  <font color="#41AD1C"># GET</font></div><div>print(session.name)  <font color="#41AD1C"># Kevin</font></div></div><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">3.</span> <span style="font-size:14pt;font-weight:bold;">Flask 请求上下文管理机制流程图</span></div></div><div><span style="font-size:14pt;"><br></span></div><ul><li><div><span style="font-size:12pt;">获取 request 或 session 的方式一</span></div></li></ul><div><font style="font-size:12pt;"><br></font></div><div><img data-filename="请求上下文1.png" src="/kevin-blog/Flask/上下文管理_files/请求上下文1.png" type="image/png"></div><div><font style="font-size:12pt;"><br></font></div><ul><li><div><span style="font-size:12pt;">获取 request 或 session 的方式二</span></div></li></ul><div><br></div><div><img data-filename="请求上下文2.png" src="/kevin-blog/Flask/上下文管理_files/请求上下文2.png" type="image/png"></div><div><br></div><h2 style="margin:10px 0px 12px;padding:0px 0px 0px 15px;font-size:21px;background-color:#3eaf7c;border-radius:3px;text-align:center;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;"><span style="font-size:21px;background-color:#3eaf7c;border-radius:3px;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;color:white;font-family:&quot;Helvetica Neue&quot;, Helvetica, Verdana, Arial, sans-serif;font-variant-caps:normal;font-variant-ligatures:normal;font-weight:bold;line-height:1.5;">Flask的app上下文管理机制</span></h2><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">1.</span> <span style="font-size:14pt;font-weight:bold;">Flask app</span><span style="font-size:14pt;font-weight:bold;">上下文管理机制的说明</span></div><div><br></div><ul><li><div>请求上下文包含了: app、g</div></li></ul><div><br></div><ul><li><div><span style="color:rgb(227, 0, 0);font-weight:bold;">注意: app上下文和请求上下文所使用的 Local LocalStack LocalProxy 都是同一个类（即: 请求上下文 和 app上下文所生成的数据都会保存在同一个 __storage__ 字典内）</span></div></li></ul><div><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">2.</span> <span style="font-size:14pt;font-weight:bold;">Flask 请求上下文管理机制重要源码分析</span></div><div><br></div><ul><li><div>类和方法的说明:</div></li></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">Local 类</span>: 为每个线程或协程开辟各自的空间储存数据</div></li><ul><li><div>通俗理解: Local 类创建了一个名为 __storage__ 字典存储着每个线程或协程的数据</div></li></ul></ul></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">LocalStack 类</span>: 帮助我们对 __storage__ 字典下的 stack 列表维护成一个栈（即: 后进先出）</div></li><ul><li><div>通俗理解: 帮助我们对 __storage__ 字典下的 stack 列表进行添加和删除操作</div></li></ul></ul></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">AppContext 类</span>: 存储着app和g等其他相关方法的类</div></li><ul><li><div>通俗理解: 实例化一个 AppContext 类得到一个 app_ctx 对象，且app_ctx对象下有app和g等其他相关方法，然后将该app_ctx对象保存在 __storage__ 字典下指定线程或协程下的 stack 列表里</div></li></ul></ul></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">LocalProxy 类</span>: 对 app_ctx 对象（即: app_context 对象）下的 g app 进行操作（即: 增删改查）</div></li><ul><li><div>通俗理解: 调用在 _lookup_app_object 函数的基础上所创建的偏函数获取到 app_ctx 对象，然后对 app_ctx 对象（即: app_context 对象）下的 g 进行操作（即: 增删改查）</div></li><li><div>通俗理解: 调用 _find_app 函数获取到 app_ctx 对象，然后对 app_ctx 对象（即: app_context 对象）下的 app 进行操作（即: 增删改查）</div></li></ul></ul></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">_lookup_app_object </span><span style="color:rgb(65, 173, 28);">函数</span>: 调用 LocalStack 下的 top 方法获取 __storage__ 下的 app_ctx 对象（即：app_context对象）中指定的属性（如: g 等）</div></li><ul><li><div>通俗理解: 通过 _lookup_app_object 函数可以获取到保存在 __storage__ 字典下指定线程或协程下的 stack 列表里 app_ctx 对象中的指定属性</div></li></ul></ul></ul><div><br></div><ul><ul><li><div><span style="color:rgb(65, 173, 28);">_find_app 函数</span>: 调用 LocalStack 下的 top 方法获取 __storage__ 下的 app_ctx 对象（即：app_context对象）中指定的属性 app</div></li><ul><li><div><span style="font-size:medium;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;color:rgb(0, 0, 0);font-family:&quot;Courier New&quot;;font-variant-caps:normal;font-variant-ligatures:normal;">通俗理解: 通过</span> _find_app <span style="font-size:medium;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;color:rgb(0, 0, 0);font-family:&quot;Courier New&quot;;font-variant-caps:normal;font-variant-ligatures:normal;">函数可以获取到保存在 __storage__ 字典下指定线程或协程下的 stack 列表里 app_ctx 对象中的指定属性 app</span></div></li></ul></ul></ul><div><br></div><ul><li><div>所存储的数据结构</div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>__storage__ = {</div><div>    '线程或协程的唯一标识': {'stack': [app_ctx, xxx, xxx]},</div><div>    '线程或协程的唯一标识': {'stack': [app_ctx, xxx, xxx]},</div><div>    '线程或协程的唯一标识': {'stack': [app_ctx, xxx, xxx]},</div><div><span style="color:rgb(65, 173, 28);">……</span></div><div>}</div></div><div><br></div><ul><li><div>查看重要源码</div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>from flask import globals</div></div><div><br></div><ul><li><div>重要的源代码</div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color:rgb(65, 173, 28);"># f.py</span></div><div><br></div><div>import functools</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 如果有协程就使用协程，如果没有则使用线程</span></div><div>try:</div><div>    from greenlet import getcurrent as get_ident</div><div>except ImportError:</div><div>    try:</div><div>        from thread import get_ident</div><div>    except ImportError:</div><div>        from _thread import get_ident</div><div><br></div><div><br></div><div><span style="color:rgb(227, 0, 0);"># 为每个线程或协程开辟各自的空间储存数据</span></div><div>class <span style="color:rgb(250, 122, 0);">Local</span>(object):</div><div>    __slots__ = (&quot;__storage__&quot;, &quot;__ident_func__&quot;)  <span style="color:rgb(65, 173, 28);"># 设置对象允许访问的变量或方法</span></div><div><br></div><div>    def __init__(self):</div><div><span style="color:rgb(65, 173, 28);"> # 调用 object.__setattr__ 方法，先将 __storage__ 和 __ident_func__ 的属性值添加到 Local 类中，然后 __setattr__ 或 __delattr__ 就可以进行调用</span></div><div>        object.__setattr__(self, &quot;__storage__&quot;, {})  <span style="color:rgb(65, 173, 28);"># __storage__ 用于存储各个线程或协程的数据的字典</span></div><div><span style="color:rgb(65, 173, 28);"> &quot;&quot;&quot;</span></div><div><span style="color:rgb(65, 173, 28);">            __storage__ 初始化的数据结构</span></div><div><span style="color:rgb(65, 173, 28);">            __storage__ = {}</span></div><div><span style="color:rgb(65, 173, 28);"></span></div><div><span style="color:rgb(65, 173, 28);">            __storage__ 添加数据后的数据结构</span></div><div><span style="color:rgb(65, 173, 28);">            __storage__ = {</span></div><div><span style="color:rgb(65, 173, 28);">                '线程或协程的唯一标识': {key: value, ……},</span></div><div><span style="color:rgb(65, 173, 28);">                '线程或协程的唯一标识': {key: value, ……},</span></div><div><span style="color:rgb(65, 173, 28);">                '线程或协程的唯一标识': {key: value, ……},</span></div><div><span style="color:rgb(65, 173, 28);">                ……</span></div><div><span style="color:rgb(65, 173, 28);">            }</span></div><div><span style="color:rgb(65, 173, 28);">        &quot;&quot;&quot;</span></div><div>        object.__setattr__(self, &quot;__ident_func__&quot;, get_ident)  <span style="color:rgb(65, 173, 28);"># __ident_func__ -&gt; 获取线程或协程的唯一标记的方法</span></div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 获取 __storage__ 中的值</span></div><div>    def __getattr__(self, name):</div><div>        try:</div><div>            return self.__storage__[self.__ident_func__()][name]</div><div>        except KeyError:</div><div>            raise AttributeError(name)</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 添加或修改 __storage__ 中的值</span></div><div>    def __setattr__(self, name, value):</div><div>        ident = self.__ident_func__()  <span style="color:rgb(65, 173, 28);"># 获取协程或线程的唯一标识</span></div><div>        storage = self.__storage__  <span style="color:rgb(65, 173, 28);"># 获取用于存储各个线程或协程的数据的字典</span></div><div>        try:</div><div>            storage[ident][name] = value</div><div>        except KeyError:</div><div>            storage[ident] = {name: value}</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 删除 __storage__ 中的值</span></div><div>    def __delattr__(self, name):</div><div>        try:</div><div>            del self.__storage__[self.__ident_func__()][name]</div><div>        except KeyError:</div><div>            raise AttributeError(name)</div><div><br></div><div><br></div><div><span style="color:rgb(227, 0, 0);"># 帮助我们对 __storage__ 字典下的 stack 列表维护成一个栈（即: 后进先出） -&gt; 通俗理解: 帮助我们对 __storage__ 字典下的 stack 列表进行添加和删除操作</span></div><div>class <span style="color:rgb(250, 122, 0);">LocalStack</span>(object):</div><div>    def __init__(self):</div><div>        self._local = Local()  <span style="color:rgb(65, 173, 28);"># 实例化local对象</span></div><div><br></div><div><span style="color:rgb(65, 173, 28);">    &quot;&quot;&quot;</span></div><div><span style="color:rgb(65, 173, 28);">        调用该类对 __storage__ 操作后的数据结构</span></div><div><span style="color:rgb(65, 173, 28);">        __storage__ = {</span></div><div><span style="color:rgb(65, 173, 28);">            '线程或协程的唯一标识': {'stack': [xxx, xxx, xxx]},</span></div><div><span style="color:rgb(65, 173, 28);">            '线程或协程的唯一标识': {'stack': [xxx, xxx, xxx]},</span></div><div><span style="color:rgb(65, 173, 28);">            '线程或协程的唯一标识': {'stack': [xxx, xxx, xxx]},</span></div><div><span style="color:rgb(65, 173, 28);">            ……</span></div><div><span style="color:rgb(65, 173, 28);">        }</span></div><div><span style="color:rgb(65, 173, 28);">    &quot;&quot;&quot;</span></div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 往 __storage__ 中的 stack 列表添加值</span></div><div>    def push(self, value):</div><div>        rv = getattr(self._local, &quot;stack&quot;, None)  <span style="color:rgb(65, 173, 28);"># 等同于 self._local.stack -&gt; 执行 Local 类中的 __getattr__ 方法</span></div><div>        if rv is None:</div><div>            self._local.stack = rv = []  <span style="color:rgb(65, 173, 28);"># 执行 Local 类中的 __setattr__ 方法</span></div><div>        rv.append(value)</div><div>        return rv</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 删除 __storage__ 中的 stack 列表的值，如果 stack 列表只有一个则不</span><font color="#41AD1C">进行删除，当请求结束的时候就会调用该方法删除当前线程中的指定 app_ctx 对象</font></div><div>    def pop(self):</div><div>        stack = getattr(self._local, &quot;stack&quot;, None)  <span style="color:rgb(65, 173, 28);"># 等同于 self._local.stack -&gt; 执行 Local 类中的 __getattr__ 方法</span></div><div>        if stack is None:</div><div>            return None</div><div>        elif len(stack) == 1:</div><div><span style="color:rgb(65, 173, 28);"># release_local(self._local)</span></div><div>            return stack[-1]</div><div>        else:</div><div>            return stack.pop()</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 获取 __storage__ 中的 stack 列表的值</span></div><div>    @property</div><div>    def top(self):</div><div>        try:</div><div>            return self._local.stack[-1]</div><div>        except (AttributeError, IndexError):</div><div>            return None</div><div><br></div><div><br></div><div><span style="color:rgb(227, 0, 0);"># 代理 -&gt; 对 ctx/app_ctx 对象（即: request_context/app_context 对象）下的 request session g app 进行操作（即: 增删改查）</span></div><div>class <span style="color:rgb(250, 122, 0);">LocalProxy</span>(object):</div><div>    __slots__ = (&quot;__local&quot;, &quot;__dict__&quot;, &quot;__name__&quot;, &quot;__wrapped__&quot;)</div><div><br></div><div>    def __init__(self, local, name=None):</div><div><span style="color:rgb(65, 173, 28);">&quot;&quot;&quot;</span></div><div><span style="color:rgb(65, 173, 28);">        :param local:  偏函数</span></div><div><span style="color:rgb(65, 173, 28);">        :param name:  request、session、g、None</span></div><div><span style="color:rgb(65, 173, 28);">        &quot;&quot;&quot;</span></div><div><br></div><div><span style="color:rgb(65, 173, 28);">        &quot;&quot;&quot;</span></div><div><span style="color:rgb(65, 173, 28);">            object.__setattr__(self, &quot;_LocalProxy__local&quot;, local) 的解释：</span></div><div><span style="color:rgb(65, 173, 28);">                1. 将 local 赋值给 _LocalProxy__local 属性，该属性可以通过 self.__local 进行访问</span></div><div><span style="color:rgb(65, 173, 28);">                2. _LocalProxy__local属性名 等于 __local 属性名</span></div><div><span style="color:rgb(65, 173, 28);">                3. 因为解释器会将 __local 替换为 _classname__local属性名 为确保名称不会与另一个类中的类似名称重叠的方式</span></div><div><span style="color:rgb(65, 173, 28);">        &quot;&quot;&quot;</span></div><div>        object.__setattr__(self, &quot;_LocalProxy__local&quot;, local)  <span style="color:rgb(65, 173, 28);"># 将 local 赋值给 _LocalProxy__local 属性，该属性可以通过 self.__local 进行访问</span></div><div>        object.__setattr__(self, &quot;__name__&quot;, name)  <span style="color:rgb(65, 173, 28);"># 将 name 赋值给 __name__ 属性</span></div><div>        if callable(local) and not hasattr(local, &quot;__release_local__&quot;):</div><div>            object.__setattr__(self, &quot;__wrapped__&quot;, local)</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 调用偏函数获取 ctx/app_ctx 对象（即: request_context/app_context 对象）</span></div><div>    def _get_current_object(self):</div><div>        if not hasattr(self.__local, &quot;__release_local__&quot;):</div><div>            return self.__local()  <font style="color:rgb(65, 173, 28);"># 调用偏函数获取 ctx/app_ctx 对象（即: request_context/app_context 对象）</font></div><div>        try:</div><div>            return getattr(self.__local, self.__name__)</div><div>        except AttributeError:</div><div>            raise RuntimeError(&quot;no object bound to %s&quot; % self.__name__)</div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 当 LocalProxy 所实例化的对象执行了 对象.属性名 的时候就会执行该方法</span></div><div>    def __getattr__(self, name):</div><div>        if name == &quot;__members__&quot;:</div><div>            return dir(self._get_current_object())</div><div>        return getattr(self._get_current_object(), name)  <span style="color:rgb(65, 173, 28);">#</span> <font color="#41AD1C">调用偏函数获取 ctx/app_ctx 对象（即: request_context/app_context 对象），然后使用反射获取 ctx/app_ctx 对象下的对应 request、session、g</font></div><div><br></div><div><span style="color:rgb(65, 173, 28);"># 当 LocalProxy 所实例化的对象执行了 对象.属性名=xxx 的时候就会执行该方法</span></div><div>    __setattr__ = lambda x, n, v: setattr(x._get_current_object(), n, v)</div><div><span style="color:rgb(65, 173, 28);"># 当 LocalProxy 所实例化的对象执行了 del 对象.属性名 的时候就会执行该方法</span></div><div>    __delattr__ = lambda x, n: delattr(x._get_current_object(), n)</div><div><span style="color:rgb(65, 173, 28);"># 当 LocalProxy 所实例化的对象执行了 print/str(对象.属性名) 的时候就会执行该方法</span></div><div>    __str__ = lambda x: str(x._get_current_object())</div><div><br></div><div><br></div><div><font color="#41AD1C"># 这里的app所指的是通过 Flask 所实例化出来的 app</font></div><div>class App:</div><div>    def __init__(self):</div><div>        self.config = 'app的配置'</div><div><br></div><div><br></div><div>class G:</div><div>    def __init__(self):</div><div>        self.name = 'Kevin'</div><div><br></div><div><br></div><div><font color="#E30000"># 一个拥有app和g信息的类</font></div><div>class <font color="#FA7A00">AppContext</font>(object):</div><div>    def __init__(self):</div><div>        self.app = App()  <font color="#41AD1C"># 注意: 这里的app所指的是通过 Flask 所实例化出来的 app 对象</font></div><div>        self.g = G()</div><div><br></div><div><br></div><div><font color="#FA7A00">_app_ctx_stack = LocalStack()  </font><font color="#41AD1C"># 实例化 LocalStack 得到 _app_ctx_stack 对象</font></div><div><font color="#FA7A00">app_context = AppContext()  </font><font color="#41AD1C"># 实例化一个 app_context 对象，里面拥有 app 和 g 等属性</font></div><div><font color="#FA7A00">_app_ctx_stack.push(app_context)  </font><font color="#41AD1C"># 将 app_context 对象，添加到 __storage__ 中的 stack 列表中</font></div><div><br></div><div><br></div><div><font color="#E30000"># 调用 LocalStack 下的 top 方法获取 __storage__ 下的 app_context 对象，然后根据传入的属性名通过反射获取 app_context 对象下对应的属性值</font></div><div>def <font color="#FA7A00">_lookup_app_object</font>(name):</div><div>    app_ctx = _app_ctx_stack.top  <font style="color:rgb(65, 173, 28);"># 调用 LocalStack 下的 top 方法获取 __storage__ 下的 app_ctx 对象（即：app_co</font><font color="#41AD1C"><font>ntext 对象</font>）</font></div><div>    return getattr(app_ctx, name) <font color="#41AD1C"> # 等同于 app_ctx.g</font></div><div><br></div><div><br></div><div><font color="#E30000"># 调用 LocalStack 下的 top 方法获取 __storage__ 下的 app_context 对象下的 app 对象</font></div><div>def <font color="#FA7A00">_find_app</font>():</div><div>    app_ctx = _app_ctx_stack.top  <font style="color:rgb(65, 173, 28);"># 调用 LocalStack 下的 top 方法获取 __storage__ 下的 app_ctx 对象（即：app_context 对象）</font></div><div>    return app_ctx.app</div><div><br></div><div><br></div><div><font color="#E30000"># 通过 LocalProxy 对 app_ctx 对象（即: app_context 对象）下的 app g 进行操作（即: 增删改查）</font></div><div><font color="#FA7A00">current_app = LocalProxy(_find_app)</font></div><div><font color="#FA7A00">g = LocalProxy(functools.partial(_lookup_app_object, 'g'))</font></div></div><div><br></div><ul style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px 0px 0px 40px;border:1px solid transparent;font-size:medium;letter-spacing:normal;orphans:2;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;"><li style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;border:1px solid transparent;"><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;"><span style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-size:medium;color:rgb(0, 0, 0);font-family:&quot;Courier New&quot;;font-variant-caps:normal;font-variant-ligatures:normal;">获取 current_app 或 g 的方式一</span></div></li></ul><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;font-size:medium;letter-spacing:normal;orphans:2;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;"><br style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;"></div><ul style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px 0px 0px 40px;border:1px solid transparent;font-size:medium;letter-spacing:normal;orphans:2;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;"><ul style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px 0px 0px 40px;border:0px;"><li style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;border:1px solid transparent;"><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;"><span style="font-size:medium;color:rgb(0, 0, 0);font-family:&quot;Courier New&quot;;font-variant-caps:normal;font-variant-ligatures:normal;">在视图函数中也可以通过 flask.globals._app_ctx_stack 中的 _app_ctx_stack 进行获取</span></div></li></ul></ul><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;"><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font color="#41AD1C"># v.py</font></div><div><br></div><div>from f import _app_ctx_stack</div><div><br></div><div>current_app = _app_ctx_stack.top.app</div><div>print(current_app.config)  <font color="#41AD1C"># app的配置</font></div><div><font color="#41AD1C"><br></font></div><div>g = _app_ctx_stack.top.g</div><div>print(g.name)  <font color="#41AD1C"># Kevin</font></div></div><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;"><br></div><ul><li><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;"><span style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;">获取 current_app 或 g 的方式二</span></div></li></ul><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;"><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font color="#41AD1C"># v.py</font></div><div><br></div><div>from f import current_app, g</div><div><br></div><div>print(current_app.config)  <font color="#41AD1C"># app的配置</font></div><div>print(g.name)  <font color="#41AD1C"># Kevin</font></div></div><div style="box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0px;padding:0px;"><br></div><div><span style="font-size:14pt;white-space:pre-wrap;font-weight:bold;">3.</span> <span style="font-size:14pt;font-weight:bold;">Flask app上下文管理机制流程图</span></div></div><div><br></div><ul><li><div><span style="font-size:12pt;">获取 current_app 或 g 的方式一</span></div></li></ul><div><br></div><div><img data-filename="app上下文1.png" src="/kevin-blog/Flask/上下文管理_files/app上下文1.png" type="image/png"></div><div><br></div><ul><li><div><span style="font-size:12pt;">获取 current_app 或 g 的方式二</span></div></li></ul><div><br></div><div><img data-filename="app上下文2.png" src="/kevin-blog/Flask/上下文管理_files/app上下文2.png" type="image/png"></div><div><br></div></div><h2 style="margin:10px 0px 12px;padding:0px 0px 0px 15px;font-size:21px;background-color:#3eaf7c;border-radius:3px;text-align:center;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;"><span style="font-size:21px;background-color:#3eaf7c;border-radius:3px;text-shadow:rgb(34, 34, 34) 1px 1px 2px;letter-spacing:normal;orphans:2;text-indent:0px;text-transform:none;white-space:normal;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;color:white;font-family:&quot;Helvetica Neue&quot;, Helvetica, Verdana, Arial, sans-serif;font-variant-caps:normal;font-variant-ligatures:normal;font-weight:bold;line-height:1.5;">上下文管理机制总的流程图</span></h2><div><br></div><ul><li><div>所存储的数据结构</div></li></ul><div><br></div><div style="box-sizing:border-box;padding:8px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:rgb(51, 51, 51);border-radius:4px;background-color:rgb(251, 250, 248);border:1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>__storage__ = {</div><div>    '线程或协程的唯一标识': {'stack': [ctx, app_ctx, xxx]},</div><div>    '线程或协程的唯一标识': {'stack': [ctx, app_ctx, xxx]},</div><div>    '线程或协程的唯一标识': {'stack': [ctx, app_ctx, xxx]},</div><div><span style="color:rgb(65, 173, 28);">……</span></div><div>}</div></div><div><br></div><ul><li><div>请求和app上下文管理机制总的流程图</div></li></ul><div><br></div><div><img data-filename="上下文管理机制.png" src="/kevin-blog/Flask/上下文管理_files/上下文管理机制.png" type="image/png"></div><div><br></div><div><br></div></div><div><br></div></span></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/kevin-blog/Flask/werkzeug 模块的使用.html" class="prev">
        werkzeug 模块的使用
      </a></span> <span class="next"><a href="/kevin-blog/Flask/中间件.html">
        中间件
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/kevin-blog/assets/js/app.dd46475d.js" defer></script><script src="/kevin-blog/assets/js/2.97d04891.js" defer></script><script src="/kevin-blog/assets/js/116.b3eb5cab.js" defer></script>
  </body>
</html>
